From ebf6a8a75b12c26471c994c67956754046a3c96e Mon Sep 17 00:00:00 2001
From: Jeremy <jpuhlman@mvista.com>
Date: Tue, 8 Jan 2019 19:41:53 +0000
Subject: [PATCH 1/2] CVE-2018-16843 nginx: Excessive memory consumption via
 flaw in HTTP/2 implementation

nginx before versions 1.15.6 and 1.14.1 has a vulnerability in
the implementation of HTTP/2 that can allow for excessive memory
consumption. This issue affects nginx compiled with the
ngx_http_v2_module (not compiled by default) if the 'http2'
option of the 'listen' directive is used in a configuration file.

http://hg.nginx.org/nginx/rev/1c6b6163c039

Upstream-Status: Backport

---
 src/http/v2/ngx_http_v2.c | 12 +++++++++++-
 src/http/v2/ngx_http_v2.h |  1 +
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/http/v2/ngx_http_v2.c b/src/http/v2/ngx_http_v2.c
index 55db58e..429d06a 100644
--- a/src/http/v2/ngx_http_v2.c
+++ b/src/http/v2/ngx_http_v2.c
@@ -654,6 +654,7 @@ ngx_http_v2_handle_connection(ngx_http_v2_connection_t *h2c)
 
     h2c->pool = NULL;
     h2c->free_frames = NULL;
+    h2c->frames = 0;
     h2c->free_fake_connections = NULL;
 
 #if (NGX_HTTP_SSL)
@@ -2640,7 +2641,7 @@ ngx_http_v2_get_frame(ngx_http_v2_connection_t *h2c, size_t length,
 
         frame->blocked = 0;
 
-    } else {
+    } else if (h2c->frames < 10000) {
         pool = h2c->pool ? h2c->pool : h2c->connection->pool;
 
         frame = ngx_pcalloc(pool, sizeof(ngx_http_v2_out_frame_t));
@@ -2664,6 +2665,15 @@ ngx_http_v2_get_frame(ngx_http_v2_connection_t *h2c, size_t length,
         frame->last = frame->first;
 
         frame->handler = ngx_http_v2_frame_handler;
+
+        h2c->frames++;
+
+    } else {
+        ngx_log_error(NGX_LOG_INFO, h2c->connection->log, 0,
+                      "http2 flood detected");
+
+        h2c->connection->error = 1;
+        return NULL;
     }
 
 #if (NGX_DEBUG)
diff --git a/src/http/v2/ngx_http_v2.h b/src/http/v2/ngx_http_v2.h
index 7d2a2ea..49398b9 100644
--- a/src/http/v2/ngx_http_v2.h
+++ b/src/http/v2/ngx_http_v2.h
@@ -115,6 +115,7 @@ struct ngx_http_v2_connection_s {
     ngx_http_connection_t           *http_connection;
 
     ngx_uint_t                       processing;
+    ngx_uint_t                       frames;
 
     size_t                           send_window;
     size_t                           recv_window;
-- 
2.11.1

