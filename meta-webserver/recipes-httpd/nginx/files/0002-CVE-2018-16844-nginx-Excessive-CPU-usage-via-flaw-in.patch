From 616b15082509840407e64095ea46e1c70e24169a Mon Sep 17 00:00:00 2001
From: Jeremy <jpuhlman@mvista.com>
Date: Tue, 8 Jan 2019 19:46:30 +0000
Subject: [PATCH 2/2] CVE-2018-16844 nginx: Excessive CPU usage via flaw in
 HTTP/2 implementation

nginx before versions 1.15.6 and 1.14.1 has a vulnerability in the
implementation of HTTP/2 that can allow for excessive CPU usage.
This issue affects nginx compiled with the ngx_http_v2_module
(not compiled by default) if the 'http2' option of the 'listen'
directive is used in a configuration file.

http://hg.nginx.org/nginx/rev/9200b41db765

Upstream-Status: Backport

---
 src/http/v2/ngx_http_v2.c | 13 ++++++++++---
 src/http/v2/ngx_http_v2.h |  1 +
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/http/v2/ngx_http_v2.c b/src/http/v2/ngx_http_v2.c
index 429d06a..638ffaf 100644
--- a/src/http/v2/ngx_http_v2.c
+++ b/src/http/v2/ngx_http_v2.c
@@ -4206,12 +4206,19 @@ ngx_http_v2_idle_handler(ngx_event_t *rev)
 
 #endif
 
-    c->destroyed = 0;
-    ngx_reusable_connection(c, 0);
-
     h2scf = ngx_http_get_module_srv_conf(h2c->http_connection->conf_ctx,
                                          ngx_http_v2_module);
 
+    if (h2c->idle++ > 10 * h2scf->max_requests) {
+        ngx_log_error(NGX_LOG_INFO, h2c->connection->log, 0,
+                      "http2 flood detected");
+        ngx_http_v2_finalize_connection(h2c, NGX_HTTP_V2_NO_ERROR);
+        return;
+    }
+
+    c->destroyed = 0;
+    ngx_reusable_connection(c, 0);
+
     h2c->pool = ngx_create_pool(h2scf->pool_size, h2c->connection->log);
     if (h2c->pool == NULL) {
         ngx_http_v2_finalize_connection(h2c, NGX_HTTP_V2_INTERNAL_ERROR);
diff --git a/src/http/v2/ngx_http_v2.h b/src/http/v2/ngx_http_v2.h
index 49398b9..6c42fee 100644
--- a/src/http/v2/ngx_http_v2.h
+++ b/src/http/v2/ngx_http_v2.h
@@ -116,6 +116,7 @@ struct ngx_http_v2_connection_s {
 
     ngx_uint_t                       processing;
     ngx_uint_t                       frames;
+    ngx_uint_t                       idle;
 
     size_t                           send_window;
     size_t                           recv_window;
-- 
2.11.1

