From 8b662fa8e267ace86f690948d4457cc8ee9d8f60 Mon Sep 17 00:00:00 2001
From: Ruslan Ermilov <ru@nginx.com>
Date: Mon, 23 Dec 2019 15:45:46 +0300
Subject: [PATCH] Discard request body when redirecting to a URL via
 error_page.

Reported by Bert JW Regeer and Francisco Oca Gonzalez.

Upstream status: backport(https://github.com/nginx/nginx/commit/c1be55f97211)
CVE: CVE-2019-20372

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 src/http/ngx_http_special_response.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/src/http/ngx_http_special_response.c b/src/http/ngx_http_special_response.c
index c9b1017..aabd5c0 100644
--- a/src/http/ngx_http_special_response.c
+++ b/src/http/ngx_http_special_response.c
@@ -606,6 +606,12 @@ ngx_http_send_error_page(ngx_http_request_t *r, ngx_http_err_page_t *err_page)
         return ngx_http_named_location(r, &uri);
     }
 
+    r->expect_tested = 1;
+
+    if (ngx_http_discard_request_body(r) != NGX_OK) {
+        r->keepalive = 0;
+    }
+
     location = ngx_list_push(&r->headers_out.headers);
 
     if (location == NULL) {
-- 
2.7.4

