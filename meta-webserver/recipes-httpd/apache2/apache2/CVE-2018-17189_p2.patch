From 60680c2bcf37e8360faa45f55b48eb1d1c0ee42d Mon Sep 17 00:00:00 2001
From: Stefan Eissing <icing@apache.org>
Date: Tue, 15 Jan 2019 10:00:06 +0000
Subject: [PATCH 2/2] Merge of r1846125 from trunk:

mod_http2: change in cleanup strategy for slave connections.

git-svn-id: https://svn.apache.org/repos/asf/httpd/httpd/branches/2.4.x@1851329 13f79535-47bb-0310-9956-ffa450edef68

Omitted version changes as they can be added on package upgrade.

Upstream-Status: Backport from https://svn.apache.org/viewvc?view=revision&revision=1851329
CVE: CVE-2018-17189
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 modules/http2/h2_conn.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/modules/http2/h2_conn.c b/modules/http2/h2_conn.c
index 41c0823..2029820 100644
--- a/modules/http2/h2_conn.c
+++ b/modules/http2/h2_conn.c
@@ -365,6 +365,15 @@ apr_status_t h2_slave_run_pre_connection(conn_rec *slave, apr_socket_t *csd)
          * (Not necessarily in pre_connection, but later. Set it here, so it
          * is in place.) */
         slave->keepalives = 1;
+        /* We signal that this connection will be closed after the request.
+         * Which is true in that sense that we throw away all traffic data
+         * on this slave connection after each requests. Although we might
+         * reuse internal structures like memory pools.
+         * The wanted effect of this is that httpd does not try to clean up
+         * any dangling data on this connection when a request is done. Which
+         * is unneccessary on a h2 stream.
+         */
+        slave->keepalive = AP_CONN_CLOSE;
         return ap_run_pre_connection(slave, csd);
     }
     return APR_SUCCESS;
-- 
2.7.4

