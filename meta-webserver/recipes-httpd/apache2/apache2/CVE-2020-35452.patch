From 08123975842c3e79d072f3b94498b6daf522dd0d Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Fri, 29 Oct 2021 17:38:50 +0530
Subject: [PATCH 4/4] mod_auth_digest: Fast validation of the nonce's base64 to
 fail early if the format can't match anyway.

Upstream-status: Backport [https://github.com/apache/httpd/commit/3b6431e]
CVE: CVE-2020-35452
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 modules/aaa/mod_auth_digest.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/modules/aaa/mod_auth_digest.c b/modules/aaa/mod_auth_digest.c
index afaf2ce..1cd2262 100644
--- a/modules/aaa/mod_auth_digest.c
+++ b/modules/aaa/mod_auth_digest.c
@@ -1420,9 +1420,14 @@ static int check_nonce(request_rec *r, digest_header_rec *resp,
     time_rec nonce_time;
     char tmp, hash[NONCE_HASH_LEN+1];
 
-    if (strlen(resp->nonce) != NONCE_LEN) {
+    /* Since the time part of the nonce is a base64 encoding of an
+     * apr_time_t (8 bytes), it should end with a '=', fail early otherwise.
+     */
+    if (strlen(resp->nonce) != NONCE_LEN
+            || resp->nonce[NONCE_TIME_LEN - 1] != '=') {
         ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r, APLOGNO(01775)
-                      "invalid nonce %s received - length is not %d",
+                      "invalid nonce '%s' received - length is not %d "
+                      "or time encoding is incorrect",
                       resp->nonce, NONCE_LEN);
         note_digest_auth_failure(r, conf, resp, 1);
         return HTTP_UNAUTHORIZED;
-- 
2.7.4

