From 95efa7dcb3c8b355e5a294fc952c0b6747c8833f Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 6 Jan 2022 11:19:28 +0530
Subject: [PATCH] CVE-2021-44790

Upstream-Status: Backport from https://svn.apache.org/viewvc?view=revision&revision=1896039

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 modules/lua/lua_request.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/modules/lua/lua_request.c b/modules/lua/lua_request.c
index 67ff432..cffed4b 100644
--- a/modules/lua/lua_request.c
+++ b/modules/lua/lua_request.c
@@ -410,7 +410,8 @@ static int req_parsebody(lua_State *L)
             if (end == NULL) break;
             key = (char *) apr_pcalloc(r->pool, 256);
             filename = (char *) apr_pcalloc(r->pool, 256);
-            vlen = end - crlf - 8;
+            if (end - crlf <= 8) break;
+	    vlen = end - crlf - 8;
             buffer = (char *) apr_pcalloc(r->pool, vlen+1);
             memcpy(buffer, crlf + 4, vlen);
             sscanf(start + len + 2,
-- 
2.25.1

