From 8297ea550910cc54a1379523e2ba3ac98cc14386 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 1 Feb 2023 04:55:06 +0000
Subject: [PATCH] SECURITY: CVE-2022-36760 (cve.mitre.org)

Ensure connection closure for an invalid Transfer-Encoding header,
to prevent HTTP request smuggling attack with an AJP proxy.

cleanup on error

Upstream-Status: Backport [https://svn.apache.org/viewvc?view=revision&revision=1906540]
CVE: CVE-2022-36760
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 modules/proxy/mod_proxy_ajp.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/modules/proxy/mod_proxy_ajp.c b/modules/proxy/mod_proxy_ajp.c
index 226ad9b..1449aca 100644
--- a/modules/proxy/mod_proxy_ajp.c
+++ b/modules/proxy/mod_proxy_ajp.c
@@ -257,6 +257,8 @@ static int ap_proxy_ajp_request(apr_pool_t *p, request_rec *r,
             ap_log_rerror(APLOG_MARK, APLOG_ERR, 0, r, APLOGNO(10396)
                           "%s Transfer-Encoding is not supported",
                           tenc);
+            /* We had a failure: Close connection to backend */
+            conn->close = 1;
             return HTTP_INTERNAL_SERVER_ERROR;
         }
     } else {
-- 
2.18.2

