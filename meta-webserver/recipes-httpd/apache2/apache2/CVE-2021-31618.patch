From 5406383768771b046416f59055f17c60f66dbd2e Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Fri, 29 Oct 2021 17:27:51 +0530
Subject: [PATCH 2/4] fix NULL pointer dereference on specially crafted HTTP/2
 request

Upstream-status: Backport [http://svn.apache.org/viewvc/httpd/httpd/branches/2.4.x/modules/http2/h2_stream.c?r1=1889759&r2=1889758&pathrev=1889759]
CVE: CVE-2021-31618
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 modules/http2/h2_stream.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/modules/http2/h2_stream.c b/modules/http2/h2_stream.c
index 925f3d6..7b82b6a 100644
--- a/modules/http2/h2_stream.c
+++ b/modules/http2/h2_stream.c
@@ -652,7 +652,7 @@ void h2_stream_set_request(h2_stream *stream, const h2_request *r)
 
 static void set_error_response(h2_stream *stream, int http_status)
 {
-    if (!h2_stream_is_ready(stream)) {
+    if (!h2_stream_is_ready(stream) && stream->rtmp) {
         conn_rec *c = stream->session->c;
         apr_bucket *b;
         h2_headers *response;
-- 
2.7.4

