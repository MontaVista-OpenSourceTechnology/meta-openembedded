From 2ac0be07aa347652aa93f7bdc942da3f8ce55b49 Mon Sep 17 00:00:00 2001
From: Jeremy <jpuhlman@mvista.com>
Date: Tue, 8 Jan 2019 05:15:11 +0000
Subject: [PATCH] CVE-2018-18066: Varbind Null pointer exceptions

Pull in fixes:
https://sourceforge.net/p/net-
snmp/code/ci/7ffb8e25a0db851953155de91f0170e9bf8c457d/
https://sourceforge.net/p/net-
snmp/code/ci/f23bcd3ac6ddee5d0a48f9703007ccc738914791/

The second patch is already partially included in the already included
dont-return-incompletely-parsed-varbinds.patch patch. This patch
includes the last bits of it.

Upstream-Status: Backport

---
 agent/helpers/table.c | 4 ++++
 snmplib/snmp_api.c    | 4 ++--
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/agent/helpers/table.c b/agent/helpers/table.c
index 882e84c..b943d6e 100644
--- a/agent/helpers/table.c
+++ b/agent/helpers/table.c
@@ -406,6 +406,8 @@ table_helper_handler(netsnmp_mib_handler *handler,
             if (reqinfo->mode == MODE_GET)
                 table_helper_cleanup(reqinfo, request,
                                      SNMP_NOSUCHOBJECT);
+            else
+                request->processed = 1; /* skip if next handler called */
             continue;
         }
 
@@ -483,6 +485,8 @@ table_helper_handler(netsnmp_mib_handler *handler,
 #endif /* NETSNMP_NO_WRITE_SUPPORT */
                     table_helper_cleanup(reqinfo, request,
                                          SNMP_NOSUCHOBJECT);
+                else
+                    request->processed = 1; /* skip if next handler called */
                 continue;
             }
             /*
diff --git a/snmplib/snmp_api.c b/snmplib/snmp_api.c
index 15a2d39..4301291 100644
--- a/snmplib/snmp_api.c
+++ b/snmplib/snmp_api.c
@@ -4507,9 +4507,9 @@ snmp_pdu_parse(netsnmp_pdu *pdu, u_char * data, size_t * length)
         data = snmp_parse_var_op(data, objid, &vp->name_length, &vp->type,
                                  &vp->val_len, &var_val, length);
         if (data == NULL)
-            return -1;
+            goto fail;
         if (snmp_set_var_objid(vp, objid, vp->name_length))
-            return -1;
+            goto fail;
 
         len = MAX_PACKET_LENGTH;
         DEBUGDUMPHEADER("recv", "Value");
-- 
2.11.1

