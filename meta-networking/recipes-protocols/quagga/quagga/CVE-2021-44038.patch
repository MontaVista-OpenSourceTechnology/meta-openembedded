From 88d654cee8363b72a0fbf2dbf90a97c2a857485a Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Thu, 8 Dec 2022 06:17:33 +0000
Subject: [PATCH] CVE-2021-44038

---
 configure.ac               |  2 +-
 redhat/bgpd.service        |  3 +++
 redhat/isisd.service       |  3 +++
 redhat/nhrpd.service       |  3 +++
 redhat/ospf6d.service      |  3 +++
 redhat/ospfd.service       |  3 +++
 redhat/pimd.service        |  3 +++
 redhat/quagga.sysconfig    |  6 ++++++
 redhat/quagga.sysconfig.in | 31 +++++++++++++++++++++++++++++++
 redhat/ripd.service        |  3 +++
 redhat/ripngd.service      |  3 +++
 redhat/zebra.service       |  4 ++++
 12 files changed, 66 insertions(+), 1 deletion(-)
 create mode 100644 redhat/quagga.sysconfig.in

diff --git a/configure.ac b/configure.ac
index db66356..74c4f7f 100755
--- a/configure.ac
+++ b/configure.ac
@@ -1670,7 +1670,7 @@ AC_CONFIG_FILES([Makefile lib/Makefile qpb/Makefile zebra/Makefile ripd/Makefile
 	  redhat/Makefile
 	  pkgsrc/Makefile
 	  fpm/Makefile
-	  redhat/quagga.spec 
+	  redhat/quagga.spec redhat/quagga.sysconfig
 	  lib/version.h
 	  isisd/topology/Makefile
 	  pkgsrc/bgpd.sh pkgsrc/ospf6d.sh pkgsrc/ospfd.sh
diff --git a/redhat/bgpd.service b/redhat/bgpd.service
index ef24841..a50bfff 100644
--- a/redhat/bgpd.service
+++ b/redhat/bgpd.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/bgpd.conf
+Documentation=man:bgpd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/bgpd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/bgpd.conf
 ExecStart=/usr/sbin/bgpd -d $BGPD_OPTS -f /etc/quagga/bgpd.conf
 Restart=on-abort
 
diff --git a/redhat/isisd.service b/redhat/isisd.service
index edb6eea..93663aa 100644
--- a/redhat/isisd.service
+++ b/redhat/isisd.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/isisd.conf
+Documentation=man:isisd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/isisd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/isisd.conf
 ExecStart=/usr/sbin/isisd -d $ISISD_OPTS -f /etc/quagga/isisd.conf
 Restart=on-abort
 
diff --git a/redhat/nhrpd.service b/redhat/nhrpd.service
index 63f138c..5b4120d 100644
--- a/redhat/nhrpd.service
+++ b/redhat/nhrpd.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/nhrpd.conf
+Documentation=man:nhrpd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/nhrpd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/nhrpd.conf
 ExecStart=/usr/sbin/nhrpd -d $NHRPD_OPTS -f /etc/quagga/nhrpdd.conf
 Restart=on-abort
 
diff --git a/redhat/ospf6d.service b/redhat/ospf6d.service
index b53b970..3c1c978 100644
--- a/redhat/ospf6d.service
+++ b/redhat/ospf6d.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/ospf6d.conf
+Documentation=man:ospf6d
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/ospf6d.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/ospf6d.conf
 ExecStart=/usr/sbin/ospf6d -d $OSPF6D_OPTS -f /etc/quagga/ospf6d.conf
 Restart=on-abort
 
diff --git a/redhat/ospfd.service b/redhat/ospfd.service
index 5d6c5bb..0084b6c 100644
--- a/redhat/ospfd.service
+++ b/redhat/ospfd.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/ospfd.conf
+Documentation=man:ospfd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/ospfd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/ospfd.conf
 ExecStart=/usr/sbin/ospfd -d $OSPFD_OPTS -f /etc/quagga/ospfd.conf
 Restart=on-abort
 
diff --git a/redhat/pimd.service b/redhat/pimd.service
index d62fe64..1916846 100644
--- a/redhat/pimd.service
+++ b/redhat/pimd.service
@@ -3,10 +3,13 @@ Description=PIM multicast routing engine
 BindTo=zebra.service
 After=syslog.target network.target zebra.service
 ConditionPathExists=/etc/quagga/pimd.conf
+Documentation=man:pimd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/pimd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/pimd.conf
 ExecStart=/usr/sbin/pimd -d $PIMD_OPTS -f /etc/quagga/pimd.conf
 Restart=on-abort
 
diff --git a/redhat/quagga.sysconfig b/redhat/quagga.sysconfig
index caa0fff..8353b13 100644
--- a/redhat/quagga.sysconfig
+++ b/redhat/quagga.sysconfig
@@ -11,6 +11,12 @@ RIPNGD_OPTS="-A ::1"
 ZEBRA_OPTS="-A 127.0.0.1"
 PIMD_OPTS="-A 127.0.0.1"
 
+# Default: The compiled in default user and group(s), useful to
+# system startup to chmod config files.
+QUAGGA_USER=quagga
+QUAGGA_GROUP=quagga
+VTY_GROUP=
+
 # Watchquagga configuration for LSB initscripts
 #
 # (Not needed with systemd: the service files are configured to automatically
diff --git a/redhat/quagga.sysconfig.in b/redhat/quagga.sysconfig.in
new file mode 100644
index 0000000..cef57a4
--- /dev/null
+++ b/redhat/quagga.sysconfig.in
@@ -0,0 +1,31 @@
+#
+# Default: Bind all daemon vtys to the loopback(s) only
+#
+BABELD_OPTS="-A 127.0.0.1"
+BGPD_OPTS="-A 127.0.0.1"
+ISISD_OPTS="-A ::1"
+OSPF6D_OPTS="-A ::1"
+OSPFD_OPTS="-A 127.0.0.1"
+RIPD_OPTS="-A 127.0.0.1"
+RIPNGD_OPTS="-A ::1"
+ZEBRA_OPTS="-A 127.0.0.1"
+PIMD_OPTS="-A 127.0.0.1"
+
+# Default: The compiled in default user and group(s), useful to
+# system startup to chmod config files.
+QUAGGA_USER=@enable_user@
+QUAGGA_GROUP=@enable_group@
+VTY_GROUP=@enable_vty_group@
+
+# Watchquagga configuration for LSB initscripts
+#
+# (Not needed with systemd: the service files are configured to automatically
+# restart any daemon on failure. If zebra fails, all running daemons will be
+# stopped; zebra will be started again; and then the previously running daemons
+# will be started again.)
+#
+# Uncomment and edit this line to reflect the daemons you are actually using:
+#WATCH_DAEMONS="zebra bgpd ospfd ospf6d ripd ripngd"
+#
+# Timer values can be adjusting by editing this line:
+WATCH_OPTS="-Az -b_ -r/sbin/service_%s_restart -s/sbin/service_%s_start -k/sbin/service_%s_stop"
diff --git a/redhat/ripd.service b/redhat/ripd.service
index ed7f922..103b5a9 100644
--- a/redhat/ripd.service
+++ b/redhat/ripd.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/ripd.conf
+Documentation=man:ripd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/ripd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/ripd.conf
 ExecStart=/usr/sbin/ripd -d $RIPD_OPTS -f /etc/quagga/ripd.conf
 Restart=on-abort
 
diff --git a/redhat/ripngd.service b/redhat/ripngd.service
index 2519b31..6fe6ba8 100644
--- a/redhat/ripngd.service
+++ b/redhat/ripngd.service
@@ -5,10 +5,13 @@ Wants=network.target
 After=zebra.service network-pre.target
 Before=network.target
 ConditionPathExists=/etc/quagga/ripngd.conf
+Documentation=man:ripngd
 
 [Service]
 Type=forking
 EnvironmentFile=/etc/sysconfig/quagga
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/ripngd.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /etc/quagga/ripngd.conf
 ExecStart=/usr/sbin/ripngd -d $RIPNGD_OPTS -f /etc/quagga/ripngd.conf
 Restart=on-abort
 
diff --git a/redhat/zebra.service b/redhat/zebra.service
index f9107f1..fa5a004 100644
--- a/redhat/zebra.service
+++ b/redhat/zebra.service
@@ -4,11 +4,15 @@ Wants=network.target
 Before=network.target
 After=network-pre.target
 ConditionPathExists=/etc/quagga/zebra.conf
+Documentation=man:zebra
 
 [Service]
 Type=forking
 EnvironmentFile=-/etc/sysconfig/quagga
 ExecStartPre=/sbin/ip route flush proto zebra
+ExecStartPre=-/bin/chmod -f 640 /etc/quagga/vtysh.conf /etc/quagga/zebra.conf
+ExecStartPre=-/bin/chown -f $QUAGGA_USER:$QUAGGA_GROUP /run/quagga /etc/quagga/zebra.conf
+ExecStartPre=-/bin/chown -f ${QUAGGA_USER}${VTY_GROUP:+":$VTY_GROUP"} quaggavty /etc/quagga/vtysh.conf
 ExecStart=/usr/sbin/zebra -d $ZEBRA_OPTS -f /etc/quagga/zebra.conf
 Restart=on-abort
 
-- 
2.18.2

