From c09203e273a4677c27c97fd117f55239c87dd0f7 Mon Sep 17 00:00:00 2001
From: Gerald Combs <gerald@wireshark.org>
Date: Fri, 7 Feb 2020 11:17:35 -0800
Subject: [PATCH 1/4] WiMax DLMAP: Add a length check.

Make sure we have enough data for a CRC.

Upstream Status: Backport [https://code.wireshark.org/review/gitweb?p=wireshark.git;a=commit;h=93d6b03a6795]
CVE: CVE-2020-9430 patch #1

Bug: 16368
Change-Id: I03a2532061a5cf5e28cb65c83dd4ab90654d1679
Reviewed-on: https://code.wireshark.org/review/36051
Reviewed-by: Gerald Combs <gerald@wireshark.org>
Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 plugins/wimax/.editorconfig | 10 ++++++++++
 plugins/wimax/msg_dlmap.c   |  9 ++++++++-
 2 files changed, 18 insertions(+), 1 deletion(-)
 create mode 100644 plugins/wimax/.editorconfig

diff --git a/plugins/wimax/.editorconfig b/plugins/wimax/.editorconfig
new file mode 100644
index 0000000..541cd9d
--- /dev/null
+++ b/plugins/wimax/.editorconfig
@@ -0,0 +1,10 @@
+#
+# Editor configuration
+#
+# https://editorconfig.org/
+#
+
+[msg_dlmap.[ch]]
+indent_style = tab
+indent_size = tab
+
diff --git a/plugins/wimax/msg_dlmap.c b/plugins/wimax/msg_dlmap.c
index 6f022cb..bb4a2e0 100644
--- a/plugins/wimax/msg_dlmap.c
+++ b/plugins/wimax/msg_dlmap.c
@@ -601,6 +601,7 @@ static int hf_dlmap_reduced_aas_spid = -1;
 
 
 static expert_field ei_dlmap_not_implemented = EI_INIT;
+static expert_field ei_mac_header_invalid_length = EI_INIT;
 
 /********************************************************************
  * DL-MAP Miscellaneous IEs and TLVs
@@ -2381,7 +2382,12 @@ gint wimax_decode_dlmapc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *base_tre
 
 	/* CRC is always appended */
 	/* check the length */
-	if (MIN(tvb_len, tvb_reported_length(tvb)) >= mac_len)
+	if (mac_len <= sizeof(mac_crc))
+	{
+		expert_add_info_format(pinfo, ti, &ei_mac_header_invalid_length,
+		"Invalid length: %d.", mac_len);
+	}
+	else if (MIN(tvb_len, tvb_reported_length(tvb)) >= mac_len)
 	{
 		/* calculate the CRC */
 		calculated_crc = wimax_mac_calc_crc32(tvb_get_ptr(tvb, 0, mac_len - (int)sizeof(mac_crc)), mac_len - (int)sizeof(mac_crc));
@@ -3418,6 +3424,7 @@ void proto_register_mac_mgmt_msg_dlmap(void)
 
 	static ei_register_info ei[] = {
 		{ &ei_dlmap_not_implemented, { "wmx.dlmap.not_implemented", PI_UNDECODED, PI_WARN, "Not implemented", EXPFILL }},
+                { &ei_mac_header_invalid_length, { "wmx.compress_dlmap.invalid_length", PI_MALFORMED, PI_ERROR, "Invalid length", EXPFILL }},
 	};
 
 	expert_module_t* expert_mac_mgmt_msg_dlmap;
-- 
2.26.2

