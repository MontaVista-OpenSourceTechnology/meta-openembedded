From 49d4d6ddc36bbf89e04dbde375eca3412ec4fc57 Mon Sep 17 00:00:00 2001
From: Pascal Quantin <pascal@wireshark.org>
Date: Wed, 22 Jan 2020 11:38:02 +0100
Subject: [PATCH 3/4] LTE RRC: fix a memory leak in composite TVB handling

Upstream Status: Backport [https://code.wireshark.org/review/gitweb?p=wireshark.git;a=commit;h=086003c9d616]
CVE: CVE-2020-9431

Bug: 16341
Change-Id: Ib6c020ea3df8b39a02f742f0684fca7db96f1fc3
Reviewed-on: https://code.wireshark.org/review/35899
Petri-Dish: Pascal Quantin <pascal@wireshark.org>
Tested-by: Petri Dish Buildbot
Reviewed-by: Pascal Quantin <pascal@wireshark.org>
(cherry picked from commit adeeb7f2da801303768ce96e2cacf6a703a69c6f)
Conflicts:
	epan/dissectors/packet-lte-rrc.c
Reviewed-on: https://code.wireshark.org/review/35903
Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 epan/dissectors/asn1/lte-rrc/lte-rrc.cnf | 6 +++---
 epan/dissectors/packet-lte-rrc.c         | 6 +++---
 2 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/epan/dissectors/asn1/lte-rrc/lte-rrc.cnf b/epan/dissectors/asn1/lte-rrc/lte-rrc.cnf
index a2126a7..c73826f 100644
--- a/epan/dissectors/asn1/lte-rrc/lte-rrc.cnf
+++ b/epan/dissectors/asn1/lte-rrc/lte-rrc.cnf
@@ -414,7 +414,7 @@ MasterInformationBlock/schedulingInfoSIB1-BR-r13 TYPE=FT_UINT32 DISPLAY=BASE_DEC
           tvbuff_t *gsm_rlcmac_dl_tvb = tvb_new_composite();
           guint8 *pd = (guint8 *) wmem_alloc(actx->pinfo->pool, 1);
           pd[0] = 0x40;
-          tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_real_data(pd, 1, 1));
+          tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_child_real_data(tvb, pd, 1, 1));
           tvb_composite_append(gsm_rlcmac_dl_tvb, target_rat_msg_cont_tvb);
           tvb_composite_finalize(gsm_rlcmac_dl_tvb);
           add_new_data_source(actx->pinfo, gsm_rlcmac_dl_tvb, "GPRS DL control block");
@@ -482,7 +482,7 @@ MasterInformationBlock/schedulingInfoSIB1-BR-r13 TYPE=FT_UINT32 DISPLAY=BASE_DEC
         tvbuff_t *si_tvb = tvb_new_composite();
         guint8 *pd = (guint8 *) wmem_alloc(actx->pinfo->pool, 1);
         pd[0] = 0x06;
-        tvb_composite_append(si_tvb, tvb_new_real_data(pd, 1, 1));
+        tvb_composite_append(si_tvb, tvb_new_child_real_data(tvb, pd, 1, 1));
         tvb_composite_append(si_tvb, sys_info_list_tvb);
         tvb_composite_finalize(si_tvb);
         add_new_data_source(actx->pinfo, si_tvb, "System Information");
@@ -495,7 +495,7 @@ MasterInformationBlock/schedulingInfoSIB1-BR-r13 TYPE=FT_UINT32 DISPLAY=BASE_DEC
         tvbuff_t *gsm_rlcmac_dl_tvb = tvb_new_composite();
         guint8 *pd = (guint8 *) wmem_alloc(actx->pinfo->pool, 1);
         pd[0] = 0x40;
-        tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_real_data(pd, 1, 1));
+        tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_child_real_data(tvb, pd, 1, 1));
         tvb_composite_append(gsm_rlcmac_dl_tvb, sys_info_list_tvb);
         tvb_composite_finalize(gsm_rlcmac_dl_tvb);
         add_new_data_source(actx->pinfo, gsm_rlcmac_dl_tvb, "GPRS DL control block");
diff --git a/epan/dissectors/packet-lte-rrc.c b/epan/dissectors/packet-lte-rrc.c
index 133a974..7973c93 100644
--- a/epan/dissectors/packet-lte-rrc.c
+++ b/epan/dissectors/packet-lte-rrc.c
@@ -41915,7 +41915,7 @@ dissect_lte_rrc_T_targetRAT_MessageContainer(tvbuff_t *tvb _U_, int offset _U_,
           tvbuff_t *gsm_rlcmac_dl_tvb = tvb_new_composite();
           guint8 *pd = (guint8 *) wmem_alloc(actx->pinfo->pool, 1);
           pd[0] = 0x40;
-          tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_real_data(pd, 1, 1));
+          tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_child_real_data(tvb, pd, 1, 1));
           tvb_composite_append(gsm_rlcmac_dl_tvb, target_rat_msg_cont_tvb);
           tvb_composite_finalize(gsm_rlcmac_dl_tvb);
           add_new_data_source(actx->pinfo, gsm_rlcmac_dl_tvb, "GPRS DL control block");
@@ -41977,7 +41977,7 @@ dissect_lte_rrc_SystemInfoListGERAN_item(tvbuff_t *tvb _U_, int offset _U_, asn1
         tvbuff_t *si_tvb = tvb_new_composite();
         guint8 *pd = (guint8 *) wmem_alloc(actx->pinfo->pool, 1);
         pd[0] = 0x06;
-        tvb_composite_append(si_tvb, tvb_new_real_data(pd, 1, 1));
+        tvb_composite_append(si_tvb, tvb_new_child_real_data(tvb, pd, 1, 1));
         tvb_composite_append(si_tvb, sys_info_list_tvb);
         tvb_composite_finalize(si_tvb);
         add_new_data_source(actx->pinfo, si_tvb, "System Information");
@@ -41990,7 +41990,7 @@ dissect_lte_rrc_SystemInfoListGERAN_item(tvbuff_t *tvb _U_, int offset _U_, asn1
         tvbuff_t *gsm_rlcmac_dl_tvb = tvb_new_composite();
         guint8 *pd = (guint8 *) wmem_alloc(actx->pinfo->pool, 1);
         pd[0] = 0x40;
-        tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_real_data(pd, 1, 1));
+        tvb_composite_append(gsm_rlcmac_dl_tvb, tvb_new_child_real_data(tvb, pd, 1, 1));
         tvb_composite_append(gsm_rlcmac_dl_tvb, sys_info_list_tvb);
         tvb_composite_finalize(gsm_rlcmac_dl_tvb);
         add_new_data_source(actx->pinfo, gsm_rlcmac_dl_tvb, "GPRS DL control block");
-- 
2.26.2

