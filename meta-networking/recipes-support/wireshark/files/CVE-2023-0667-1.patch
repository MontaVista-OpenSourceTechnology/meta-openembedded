From db6962812f3f234e12e424c1c470cb935b5f19d0 Mon Sep 17 00:00:00 2001
From: Guy Harris <gharris@sonic.net>
Date: Wed, 19 Aug 2020 23:58:20 -0700
Subject: [PATCH 1/2] Add format_text_string(), which gets the length with
 strlen().

format_text(alloc, string, strlen(string)) is a common idiom; provide
format_text_string(), which does the strlen(string) for you.  (Any
string used in a %s to set the text of a protocol tree item, if it was
directly extracted from the packet, should be run through a format_text
routine, to ensure that it's valid UTF-8 and that control characters are
handled correctly.)

Update comments while we're at it.

Change-Id: Ia8549efa1c96510ffce97178ed4ff7be4b02eb6e
Reviewed-on: https://code.wireshark.org/review/38202
Petri-Dish: Guy Harris <gharris@sonic.net>
Tested-by: Petri Dish Buildbot
Reviewed-by: Guy Harris <gharris@sonic.net>

Upstream-Status: Backport [https://github.com/wireshark/wireshark/commit/35418a73f7c9cefebe392b1ea0f012fccaf89801]
CVE: CVE-2023-0667
Signed-off-by: Mahesh Mathapati <mmathapati@mvista.com>
---
 debian/libwireshark8.symbols |  1 +
 epan/strutil.c               | 24 +++++++++++++++++
 epan/strutil.h               | 51 +++++++++++++++++++++++++++++++++---
 3 files changed, 72 insertions(+), 4 deletions(-)

diff --git a/debian/libwireshark8.symbols b/debian/libwireshark8.symbols
index 456d4bc..53c9103 100644
--- a/debian/libwireshark8.symbols
+++ b/debian/libwireshark8.symbols
@@ -575,6 +575,7 @@ libwireshark.so.8 libwireshark8 #MINVER#
  follow_tvb_tap_listener@Base 2.1.0
  format_text@Base 1.9.1
  format_text_chr@Base 1.12.0~rc1
+ format_text_string@Base 3.3.0
  format_text_wsp@Base 1.9.1
  format_uri@Base 1.9.1
  fragment_add@Base 1.9.1
diff --git a/epan/strutil.c b/epan/strutil.c
index 715001e..351facc 100644
--- a/epan/strutil.c
+++ b/epan/strutil.c
@@ -243,6 +243,30 @@ format_text(const guchar *string, size_t len)
     return fmtbuf[idx];
 }

+/** Given a wmem scope and a null-terminated string, expected to be in
+ *  UTF-8 but possibly containing invalid sequences (as it may have come
+ *  from packet data), and the length of the string, generate a valid
+ *  UTF-8 string from it, allocated in the specified wmem scope, that:
+ *
+ *   shows printable Unicode characters as themselves;
+ *
+ *   shows non-printable ASCII characters as C-style escapes (octal
+ *   if not one of the standard ones such as LF -> '\n');
+ *
+ *   shows non-printable Unicode-but-not-ASCII characters as
+ *   their universal character names;
+ *
+ *   shows illegal UTF-8 sequences as a sequence of bytes represented
+ *   as C-style hex escapes;
+ *
+ *  and return a pointer to it.
+ */
+gchar *
+format_text_string(const guchar *string)
+{
+	return format_text(string, strlen(string));
+}
+
 /*
  * Given a string, generate a string from it that shows non-printable
  * characters as C-style escapes except a whitespace character
diff --git a/epan/strutil.h b/epan/strutil.h
index 62c1dac..1a0d38a 100644
--- a/epan/strutil.h
+++ b/epan/strutil.h
@@ -56,17 +56,60 @@ WS_DLL_PUBLIC
 int        get_token_len(const guchar *linep, const guchar *lineend,
     const guchar **next_token);

-/** Given a string, generate a string from it that shows non-printable
- *  characters as C-style escapes, and return a pointer to it.
+/** Given a wmem scope, a not-necessarily-null-terminated string,
+ *  expected to be in UTF-8 but possibly containing invalid sequences
+ *  (as it may have come from packet data), and the length of the string,
+ *  generate a valid UTF-8 string from it, allocated in the specified
+ *  wmem scope, that:
  *
- * @param line A pointer to the input string
+ *   shows printable Unicode characters as themselves;
+ *
+ *   shows non-printable ASCII characters as C-style escapes (octal
+ *   if not one of the standard ones such as LF -> '\n');
+ *
+ *   shows non-printable Unicode-but-not-ASCII characters as
+ *   their universal character names;
+ *
+ *   shows illegal UTF-8 sequences as a sequence of bytes represented
+ *   as C-style hex escapes;
+ *
+ *  and return a pointer to it.
+ *
+ * @param string A pointer to the input string
  * @param len The length of the input string
  * @return A pointer to the formatted string
  *
  * @see tvb_format_text()
  */
 WS_DLL_PUBLIC
-gchar*     format_text(const guchar *line, size_t len);
+gchar*     format_text(const guchar *string, size_t len);
+
+/** Given a wmem scope and a null-terminated string, expected to be in
+ *  UTF-8 but possibly containing invalid sequences (as it may have come
+ *  from packet data), and the length of the string, generate a valid
+ *  UTF-8 string from it, allocated in the specified wmem scope, that:
+ *
+ *   shows printable Unicode characters as themselves;
+ *
+ *   shows non-printable ASCII characters as C-style escapes (octal
+ *   if not one of the standard ones such as LF -> '\n');
+ *
+ *   shows non-printable Unicode-but-not-ASCII characters as
+ *   their universal character names;
+ *
+ *   shows illegal UTF-8 sequences as a sequence of bytes represented
+ *   as C-style hex escapes;
+ *
+ *  and return a pointer to it.
+ *
+ * @param allocator The wmem scope
+ * @param string A pointer to the input string
+ * @return A pointer to the formatted string
+ *
+ * @see tvb_format_text()
+ */
+WS_DLL_PUBLIC
+gchar*     format_text_string(const guchar *string);

 /**
  * Given a string, generate a string from it that shows non-printable
--
2.41.0
