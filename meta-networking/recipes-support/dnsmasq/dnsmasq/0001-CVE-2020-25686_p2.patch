From ea876a49e55093f47ec7e4d6c2f426a1eca0dd7d Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Thu, 11 Aug 2022 07:57:07 +0000
Subject: [PATCH] CVE-2020-25686_p2

Small cleanups in frec_src datastucture handling.

Upstream-Status: Backport from https://thekelleys.org.uk/gitweb/?p=dnsmasq.git;a=commit;h=6a6e06fbb0d4690507ceaf2bb6f0d8910f3d4914
CVE: CVE-2020-25686
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 src/forward.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/src/forward.c b/src/forward.c
index 2971a43..ab699a7 100644
--- a/src/forward.c
+++ b/src/forward.c
@@ -2102,14 +2102,14 @@ void free_rfd(struct randfd *rfd)
 
 static void free_frec(struct frec *f)
 {
-  struct frec_src *src, *tmp;
+  struct frec_src *last;
 
-   /* add back to freelist of not the record builtin to every frec. */
-  for (src = f->frec_src.next; src; src = tmp)
+  /* add back to freelist if not the record builtin to every frec. */
+  for (last = f->frec_src.next; last && last->next; last = last->next) ;
+  if (last)
     {
-      tmp = src->next;
-      src->next = daemon->free_frec_src;
-      daemon->free_frec_src = src;
+      last->next = daemon->free_frec_src;
+      daemon->free_frec_src = f->frec_src.next;
     }
 
   f->frec_src.next = NULL;
-- 
2.18.2

