From c88a471a2dd658076972c422b3660ab4b60fa81d Mon Sep 17 00:00:00 2001
From: TJ Saunders <tj@castaglia.org>
Date: Sat, 19 Oct 2019 12:37:56 -0700
Subject: [PATCH] Issue #846: Handle the case where a client tries to send
 too-large commands in an effort to DoS the server.

Upstream status: backport(https://github.com/proftpd/proftpd/commit/13fe9462787)
CVE: CVE-2019-18217

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 src/main.c  | 10 +++++++++-
 src/netio.c |  3 ++-
 2 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/main.c b/src/main.c
index 1ead27f..78516b5 100644
--- a/src/main.c
+++ b/src/main.c
@@ -462,6 +462,7 @@ int pr_cmd_read(cmd_rec **res) {
   static long cmd_bufsz = -1;
   static char *cmd_buf = NULL;
   int cmd_buflen;
+  unsigned int too_large_count = 0;
   char *ptr;
 
   if (res == NULL) {
@@ -487,8 +488,15 @@ int pr_cmd_read(cmd_rec **res) {
     if (cmd_buflen < 0) {
       if (errno == E2BIG) {
         /* The client sent a too-long command which was ignored; give
-         * them another chance?
+         * them a few more chances, with minor delays?
          */
+        too_large_count++;
+        pr_timer_usleep(250 * 1000);
+
+        if (too_large_count > 3) {
+          return -1;
+        }
+
         continue;
       }
 
diff --git a/src/netio.c b/src/netio.c
index d0adec1..f7af5a4 100644
--- a/src/netio.c
+++ b/src/netio.c
@@ -1,6 +1,6 @@
 /*
  * ProFTPD - FTP server daemon
- * Copyright (c) 2001-2016 The ProFTPD Project team
+ * Copyright (c) 2001-2019 The ProFTPD Project team 
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -1446,6 +1446,7 @@ int pr_netio_read(pr_netio_stream_t *nstrm, char *buf, size_t buflen,
       }
 
       nstrm->strm_errno = 0;
+      errno = EOF;
       break;
     }
 
-- 
2.7.4

