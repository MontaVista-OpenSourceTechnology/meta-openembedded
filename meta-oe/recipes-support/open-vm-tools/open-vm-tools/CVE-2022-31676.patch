From 86f97ab82b284abd89bdee40ad1255578d205877 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Thu, 2 Mar 2023 05:57:43 +0000
Subject: [PATCH] Properly check authorization on incoming guestOps requests.

Fix public pipe request checks.  Only a SessionRequest type should
be accepted on the public pipe.

Upstream-Status: Backport [https://github.com/vmware/open-vm-tools/commit/70a74758bfe0042c27f15ce590fb21a2bc54d745]
CVE: CVE-2022-31676
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 open-vm-tools/vgauth/serviceImpl/proto.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/open-vm-tools/vgauth/serviceImpl/proto.c b/open-vm-tools/vgauth/serviceImpl/proto.c
index ab36dca4..b044eace 100644
--- open-vm-tools/vgauth/serviceImpl/proto.c
+++ open-vm-tools/vgauth/serviceImpl/proto.c
@@ -1202,6 +1202,10 @@ Proto_SecurityCheckRequest(ServiceConnection *conn,
    VGAuthError err;
    gboolean isSecure = ServiceNetworkIsConnectionPrivateSuperUser(conn);
 
+   if (conn->isPublic && req->reqType != PROTO_REQUEST_SESSION_REQ) {
+      return VGAUTH_E_PERMISSION_DENIED;
+   }
+
    switch (req->reqType) {
       /*
        * This comes over the public connection; alwsys let it through.
-- 
2.18.2

