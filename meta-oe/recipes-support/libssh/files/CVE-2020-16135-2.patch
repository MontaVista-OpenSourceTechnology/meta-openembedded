From 2782cb0495b7450bd8fe43ce4af886b66fea6c40 Mon Sep 17 00:00:00 2001
From: Andreas Schneider <asn@cryptomilk.org>
Date: Wed, 3 Jun 2020 10:05:51 +0200
Subject: [PATCH] sftpserver: Add missing return check for ssh_buffer_add_data()

Signed-off-by: Andreas Schneider <asn@cryptomilk.org>
Reviewed-by: Anderson Toshiyuki Sasaki <ansasaki@redhat.com>
Reviewed-by: Jakub Jelen <jjelen@redhat.com>

Upstream-Status: Backport [https://gitlab.com/libssh/libssh-mirror/-/commit/2782cb0495b7450bd8fe43ce4af886b66fea6c40]
CVE: CVE-2020-16135
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 src/sftpserver.c | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/src/sftpserver.c b/src/sftpserver.c
index 8e722863..86f68391 100644
--- a/src/sftpserver.c
+++ b/src/sftpserver.c
@@ -70,9 +70,14 @@ sftp_client_message sftp_get_client_message(sftp_session sftp) {
       return NULL;
   }
 
-  ssh_buffer_add_data(msg->complete_message,
-                      buffer_get_rest(payload),
-                      buffer_get_rest_len(payload));
+  rc = ssh_buffer_add_data(msg->complete_message,
+                           buffer_get_rest(payload),
+                           buffer_get_rest_len(payload));
+  if (rc < 0) {
+      ssh_set_error_oom(session);
+      sftp_client_message_free(msg);
+      return NULL;
+  }
 
   buffer_get_u32(payload, &msg->id);
 
-- 
2.18.2

