From 4abc19a766e8a99cf47b5ec1d6fa529548a4794c Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 18 Apr 2022 10:09:11 +0530
Subject: [PATCH] CVE-2022-0392

Upstream-Status: Backport from https://github.com/vim/vim/commit/806d037671e133bd28a7864248763f643967973a

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/edit.c                 |  3 ++-
 src/testdir/test_paste.vim | 18 ++++++++++++++++++
 src/version.c              |  2 ++
 3 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/src/edit.c b/src/edit.c
index 3a9b3aaf9..db12f99b8 100644
--- a/src/edit.c
+++ b/src/edit.c
@@ -9561,7 +9561,8 @@ bracketed_paste(paste_mode_T mode, int drop, garray_T *gap)
 		    break;
 
 		case PASTE_EX:
-		    if (gap != NULL && ga_grow(gap, idx) == OK)
+		    // add one for the NUL that is going to be appended
+		    if (gap != NULL && ga_grow(gap, idx + 1) == OK)
 		    {
 			mch_memmove((char *)gap->ga_data + gap->ga_len,
 							     buf, (size_t)idx);
diff --git a/src/testdir/test_paste.vim b/src/testdir/test_paste.vim
index 440dc7f1f..89ba5f4a0 100644
--- a/src/testdir/test_paste.vim
+++ b/src/testdir/test_paste.vim
@@ -71,6 +71,24 @@ func Test_paste_cmdline()
   call assert_equal("\"afoo\<CR>barb", getreg(':'))
 endfunc
 
+" bracketed paste in Ex-mode
+func Test_paste_ex_mode()
+  unlet! foo
+  call feedkeys("Qlet foo=\"\<Esc>[200~foo\<CR>bar\<Esc>[201~\"\<CR>vi\<CR>", 'xt')
+  call assert_equal("foo\rbar", foo)
+
+  " pasting more than 40 bytes
+  exe "norm Q\<PasteStart>0000000000000000000000000000000000000000000000000000000000000000000000\<C-C>"
+endfunc
+
+func Test_paste_onechar()
+  new
+  let @f='abc'
+  call feedkeys("i\<C-R>\<Esc>[200~foo\<CR>bar\<Esc>[201~", 'xt')
+  call assert_equal("abc", getline(1))
+  close!
+endfunc
+
 func Test_paste_visual_mode()
   new
   call setline(1, 'here are some words')
diff --git a/src/version.c b/src/version.c
index 16413bbf5..3f12bc171 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4218,
 /**/
     4217,
 /**/
-- 
2.25.1

