From 20733144097ab1e93b8097bb3a4717c9ad9af8bf Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 7 Feb 2022 12:54:15 +0530
Subject: [PATCH] CVE-2021-4166

Upstream-Status: Backport from https://github.com/vim/vim/commit/6f98371532fcff911b462d51bc64f2ce8a6ae682

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/buffer.c                 | 7 +++++++
 src/testdir/test_arglist.vim | 7 +++++++
 src/version.c                | 2 ++
 3 files changed, 16 insertions(+)

diff --git a/src/buffer.c b/src/buffer.c
index f64255d78..daef76194 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -55,6 +55,10 @@ static void	clear_wininfo(buf_T *buf);
 # define dev_T unsigned
 #endif
 
+// This flag is set whenever the argument list is being changed and calling a
+// function that might trigger an autocommand.
+static int arglist_locked = FALSE;
+
 #if defined(FEAT_SIGNS)
 static void insert_sign(buf_T *buf, signlist_T *prev, signlist_T *next, int id, linenr_T lnum, int typenr);
 #endif
@@ -4928,6 +4932,7 @@ do_arg_all(
     tabpage_T	*old_curtab, *last_curtab;
     win_T	*new_curwin = NULL;
     tabpage_T	*new_curtab = NULL;
+    int		prev_arglist_locked = arglist_locked;
 
     if (ARGCOUNT <= 0)
     {
@@ -4947,6 +4952,7 @@ do_arg_all(
      * watch out for its size to be changed. */
     alist = curwin->w_alist;
     ++alist->al_refcount;
+    arglist_locked = TRUE;
 
     old_curwin = curwin;
     old_curtab = curtab;
@@ -5173,6 +5179,7 @@ do_arg_all(
 
     /* Remove the "lock" on the argument list. */
     alist_unlink(alist);
+    arglist_locked = prev_arglist_locked;
 
 #ifdef FEAT_AUTOCMD
     --autocmd_no_enter;
diff --git a/src/testdir/test_arglist.vim b/src/testdir/test_arglist.vim
index 2a2425a93..33282e3ff 100644
--- a/src/testdir/test_arglist.vim
+++ b/src/testdir/test_arglist.vim
@@ -356,3 +356,10 @@ func Test_arg_all_expand()
   call assert_equal('notexist Xx\ x runtest.vim', expand('##'))
   call delete('Xx x')
 endfunc
+
+func Test_clear_arglist_in_all()
+  n 0 00 000 0000 00000 000000
+  au! * 0 n 0
+  all
+  au! *
+endfunc
diff --git a/src/version.c b/src/version.c
index 715aef14e..1179e65b9 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    993,
 /**/
     992,
 /**/
-- 
2.25.1

