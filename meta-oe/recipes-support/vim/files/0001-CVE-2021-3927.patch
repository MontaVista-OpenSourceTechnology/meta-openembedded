From a646a1695cbc588a35a2eb3dfbf265f77237db2c Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Fri, 12 Nov 2021 16:40:29 +0530
Subject: [PATCH] CVE-2021-3927

Upstream-Status: Backport from https://github.com/vim/vim/commit/0b5b06cb4777d1401fdf83e7d48d287662236e7e

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/ex_docmd.c           | 1 +
 src/testdir/test_put.vim | 9 +++++++++
 src/version.c            | 2 ++
 3 files changed, 12 insertions(+)

diff --git a/src/ex_docmd.c b/src/ex_docmd.c
index c9c79075c..2a9971003 100644
--- a/src/ex_docmd.c
+++ b/src/ex_docmd.c
@@ -9468,6 +9468,7 @@ ex_put(exarg_T *eap)
 	eap->forceit = TRUE;
     }
     curwin->w_cursor.lnum = eap->line2;
+    check_cursor_col();
     do_put(eap->regname, eap->forceit ? BACKWARD : FORWARD, 1L,
 						       PUT_LINE|PUT_CURSLINE);
 }
diff --git a/src/testdir/test_put.vim b/src/testdir/test_put.vim
index 18c7f4e64..a56705bfe 100644
--- a/src/testdir/test_put.vim
+++ b/src/testdir/test_put.vim
@@ -45,3 +45,12 @@ func Test_put_lines()
   bw!
   call setreg('a', a[0], a[1])
 endfunc
+
+func Test_put_above_first_line()
+  new
+  let @" = 'text'
+  silent! normal 0o00
+  0put
+  call assert_equal('text', getline(1))
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index b14a3343f..22894d1fc 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    987,
 /**/
     986,
 /**/
-- 
2.25.1

