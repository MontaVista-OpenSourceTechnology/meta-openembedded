From 90ad5eac529d54f0e0995b2bb683f08e5281673f Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Fri, 19 Nov 2021 10:32:45 +0530
Subject: [PATCH] CVE-2021-3928

Upstream-Status: Backport from https://github.com/vim/vim/commit/15d9890eee53afc61eb0a03b878a19cb5672f732

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/spell.c                | 2 +-
 src/testdir/test_spell.vim | 8 ++++++++
 src/version.c              | 2 ++
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/spell.c b/src/spell.c
index 0eb87638e..04c63c22f 100644
--- a/src/spell.c
+++ b/src/spell.c
@@ -4751,7 +4751,7 @@ suggest_trie_walk(
 		     * char, e.g., "thes," -> "these". */
 		    p = fword + sp->ts_fidx;
 		    MB_PTR_BACK(fword, p);
-		    if (!spell_iswordp(p, curwin))
+		    if (!spell_iswordp(p, curwin) && *preword != NUL)
 		    {
 			p = preword + STRLEN(preword);
 			MB_PTR_BACK(preword, p);
diff --git a/src/testdir/test_spell.vim b/src/testdir/test_spell.vim
index e4c236c96..181497f51 100644
--- a/src/testdir/test_spell.vim
+++ b/src/testdir/test_spell.vim
@@ -328,6 +328,14 @@ func RunGoodBad(good, bad, expected_words, expected_bad_words)
   bwipe!
 endfunc
 
+func Test_spell_single_word()
+  new
+  silent! norm 0R00
+  spell! ßÂ
+  silent 0norm 0r$ Dvz=
+  bwipe!
+endfunc
+
 let g:test_data_aff1 = [
       \"SET ISO8859-1",
       \"TRY esianrtolcdugmphbyfvkwjkqxz-\xEB\xE9\xE8\xEA\xEF\xEE\xE4\xE0\xE2\xF6\xFC\xFB'ESIANRTOLCDUGMPHBYFVKWJKQXZ",
diff --git a/src/version.c b/src/version.c
index 22894d1fc..69ca48291 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    988,
 /**/
     987,
 /**/
-- 
2.25.1

