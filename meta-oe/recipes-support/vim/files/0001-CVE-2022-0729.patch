From d183f223e26db4b2aa0eb5a98b5de25467ce0a98 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 19 Apr 2022 11:19:07 +0530
Subject: [PATCH] CVE-2022-0729

Upstream-Status: Backport from https://github.com/vim/vim/commit/6456fae9ba8e72c74b2c0c499eaf09974604ff30

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/regexp.c                     | 5 +++++
 src/testdir/test_regexp_utf8.vim | 8 ++++++++
 src/version.c                    | 2 ++
 3 files changed, 15 insertions(+)

diff --git a/src/regexp.c b/src/regexp.c
index f762dee5b..4febf9f55 100644
--- a/src/regexp.c
+++ b/src/regexp.c
@@ -5684,6 +5684,11 @@ regmatch(
 			    if (reginput == regline)
 			    {
 				/* backup to last char of previous line */
+				if (reglnum == 0)
+				{
+				    status = RA_NOMATCH;
+				    break;
+				}
 				--reglnum;
 				regline = reg_getline(reglnum);
 				/* Just in case regrepeat() didn't count
diff --git a/src/testdir/test_regexp_utf8.vim b/src/testdir/test_regexp_utf8.vim
index f5b713319..d202e0a73 100644
--- a/src/testdir/test_regexp_utf8.vim
+++ b/src/testdir/test_regexp_utf8.vim
@@ -162,3 +162,11 @@ func Test_match_invalid_byte()
   bwipe!
   call delete('Xinvalid')
 endfunc
+
+func Test_match_too_complicated()
+  set regexpengine=1
+  exe "vsplit \xeb\xdb\x99"
+  silent! buf \&\zs*\zs*0
+  bwipe!
+  set regexpengine=0
+endfunc
diff --git a/src/version.c b/src/version.c
index 261a7193e..4f649cb27 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4440,
 /**/
     4247,
 /**/
-- 
2.25.1

