From 8ae33cea063cad1e5fec1c1d36781f10569ceb84 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Wed, 30 Mar 2022 16:56:01 +0530
Subject: [PATCH] CVE-2022-0351

Upstream-Status: Backport from https://github.com/vim/vim/commit/fe6fb267e6ee5c5da2f41889e4e0e0ac5bf4b89d

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/eval.c                     | 10 ++++++++++
 src/globals.h                  |  1 +
 src/testdir/test_eval_func.vim |  5 +++++
 src/version.c                  |  2 ++
 4 files changed, 18 insertions(+)

diff --git a/src/eval.c b/src/eval.c
index b8e606443..07ac4d411 100644
--- a/src/eval.c
+++ b/src/eval.c
@@ -4142,6 +4142,7 @@ eval7(
     char_u	*start_leader, *end_leader;
     int		ret = OK;
     char_u	*alias;
+    static	int recurse = 0;
 
     /*
      * Initialise variable so that clear_tv() can't mistake this for a
@@ -4157,6 +4158,15 @@ eval7(
 	*arg = skipwhite(*arg + 1);
     end_leader = *arg;
 
+    // Limit recursion to 1000 levels.  At least at 10000 we run out of stack
+    // and crash.
+    if (recurse == 1000)
+    {
+	EMSG2(_(e_expression_too_recursive_str), *arg);
+	return FAIL;
+    }
+    ++recurse;
+
     switch (**arg)
     {
     /*
diff --git a/src/globals.h b/src/globals.h
index 0b887d35b..a9f0b8c2f 100644
--- a/src/globals.h
+++ b/src/globals.h
@@ -1609,6 +1609,7 @@ EXTERN char_u e_notset[]	INIT(= N_("E764: Option '%s' is not set"));
 EXTERN char_u e_invalidreg[]    INIT(= N_("E850: Invalid register name"));
 #endif
 EXTERN char_u e_dirnotf[]	INIT(= N_("E919: Directory not found in '%s': \"%s\""));
+EXTERN char e_expression_too_recursive_str[]	INIT(= N_("E1169: Expression too recursive: %s"));
 
 #ifdef MACOS_X_UNIX
 EXTERN short disallow_gui	INIT(= FALSE);
diff --git a/src/testdir/test_eval_func.vim b/src/testdir/test_eval_func.vim
index 4fcd0421a..e71e3020e 100644
--- a/src/testdir/test_eval_func.vim
+++ b/src/testdir/test_eval_func.vim
@@ -8,3 +8,8 @@ $put ='s:Testje exists: ' . exists('s:Testje')
 $put ='func s:Testje exists: ' . exists('*s:Testje')
 $put ='Bar exists: ' . exists('Bar')
 $put ='func Bar exists: ' . exists('*Bar')
+
+func Test_deep_recursion()
+  " this was running out of stack
+  call assert_fails("exe 'if ' .. repeat('(', 1002)", 'E1169: Expression too recursive: ((')
+endfunc
diff --git a/src/version.c b/src/version.c
index cf97765b5..8a68efd5a 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    997,
 /**/
     996,
 /**/
-- 
2.25.1

