From 483cb950fa8d3792ee45629fe895c118048f50f4 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 19 Apr 2022 11:12:03 +0530
Subject: [PATCH] CVE-2022-0408

Upstream-Status: Backport from https://github.com/vim/vim/commit/06f15416bb8d5636200a10776f1752c4d6e49f31

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/spell.c                | 17 +++++++++++++++--
 src/testdir/test_spell.vim |  8 ++++++++
 src/version.c              |  2 ++
 3 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/src/spell.c b/src/spell.c
index 04c63c22f..69a129e03 100644
--- a/src/spell.c
+++ b/src/spell.c
@@ -4317,7 +4317,7 @@ suggest_try_change(suginfo_T *su)
 
 /* Check the maximum score, if we go over it we won't try this change. */
 #define TRY_DEEPER(su, stack, depth, add) \
-		(stack[depth].ts_score + (add) < su->su_maxscore)
+		(depth < MAXWLEN && stack[depth].ts_score + (add) < su->su_maxscore)
 
 /*
  * Try finding suggestions by adding/removing/swapping letters.
@@ -4389,6 +4389,9 @@ suggest_trie_walk(
     char_u	changename[MAXWLEN][80];
 #endif
     int		breakcheckcount = 1000;
+#ifdef FEAT_RELTIME
+    proftime_T	time_limit;
+#endif
     int		compound_ok;
 
     /*
@@ -4437,6 +4440,11 @@ suggest_trie_walk(
 	    sp->ts_state = STATE_START;
 	}
     }
+#ifdef FEAT_RELTIME
+    // The loop may take an indefinite amount of time. Break out after five
+    // sectonds. TODO: add an option for the time limit.
+    profile_setlimit(5000, &time_limit);
+#endif
 
     /*
      * Loop to find all suggestions.  At each round we either:
@@ -4475,7 +4483,8 @@ suggest_trie_walk(
 
 		/* At end of a prefix or at start of prefixtree: check for
 		 * following word. */
-		if (byts[arridx] == 0 || n == (int)STATE_NOPREFIX)
+		if (depth < MAXWLEN
+			    && (byts[arridx] == 0 || n == (int)STATE_NOPREFIX))
 		{
 		    /* Set su->su_badflags to the caps type at this position.
 		     * Use the caps type until here for the prefix itself. */
@@ -5835,6 +5844,10 @@ suggest_trie_walk(
 	    {
 		ui_breakcheck();
 		breakcheckcount = 1000;
+#ifdef FEAT_RELTIME
+		if (profile_passed_limit(&time_limit))
+		    got_int = TRUE;
+#endif
 	    }
 	}
     }
diff --git a/src/testdir/test_spell.vim b/src/testdir/test_spell.vim
index 181497f51..ddacae52d 100644
--- a/src/testdir/test_spell.vim
+++ b/src/testdir/test_spell.vim
@@ -336,6 +336,14 @@ func Test_spell_single_word()
   bwipe!
 endfunc
 
+func Test_spellsuggest_too_deep()
+  " This was incrementing "depth" over MAXWLEN.
+  new
+  norm s000G00ý000000000000
+  sil norm ..vzG................vvzG0     v z=
+  bwipe!
+endfunc
+
 let g:test_data_aff1 = [
       \"SET ISO8859-1",
       \"TRY esianrtolcdugmphbyfvkwjkqxz-\xEB\xE9\xE8\xEA\xEF\xEE\xE4\xE0\xE2\xF6\xFC\xFB'ESIANRTOLCDUGMPHBYFVKWJKQXZ",
diff --git a/src/version.c b/src/version.c
index 3f12bc171..261a7193e 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4247,
 /**/
     4218,
 /**/
-- 
2.25.1

