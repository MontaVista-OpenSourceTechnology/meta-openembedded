From 283917d83afbaaf833da8dd2a9c1e5eddf5ac866 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 28 Oct 2021 10:54:01 +0530
Subject: [PATCH] CVE-2021-3872

Upstream-Status: Backport from https://github.com/vim/vim/commit/826bfe4bbd7594188e3d74d2539d9707b1c6a14b

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/screen.c                    | 10 +++++-----
 src/testdir/test_statusline.vim | 10 ++++++++++
 2 files changed, 15 insertions(+), 5 deletions(-)

diff --git a/src/screen.c b/src/screen.c
index 54ba95788..b37306941 100644
--- a/src/screen.c
+++ b/src/screen.c
@@ -6885,13 +6885,13 @@ win_redr_status(win_T *wp)
 	    *(p + len++) = ' ';
 	if (bt_help(wp->w_buffer))
 	{
-	    STRCPY(p + len, _("[Help]"));
+	    vim_snprintf((char *)p + len, MAXPATHL - len, "%s", _("[Help]"));
 	    len += (int)STRLEN(p + len);
 	}
 #ifdef FEAT_QUICKFIX
 	if (wp->w_p_pvw)
 	{
-	    STRCPY(p + len, _("[Preview]"));
+	    vim_snprintf((char *)p + len, MAXPATHL - len, "%s", _("[Preview]"));
 	    len += (int)STRLEN(p + len);
 	}
 #endif
@@ -6901,12 +6901,12 @@ win_redr_status(win_T *wp)
 #endif
 		)
 	{
-	    STRCPY(p + len, "[+]");
-	    len += 3;
+	    vim_snprintf((char *)p + len, MAXPATHL - len, "%s", "[+]");
+	    len += (int)STRLEN(p + len);
 	}
 	if (wp->w_buffer->b_p_ro)
 	{
-	    STRCPY(p + len, _("[RO]"));
+	    vim_snprintf((char *)p + len, MAXPATHL - len, "%s", _("[RO]"));
 	    len += (int)STRLEN(p + len);
 	}
 
diff --git a/src/testdir/test_statusline.vim b/src/testdir/test_statusline.vim
index 351b119ac..94adf803b 100644
--- a/src/testdir/test_statusline.vim
+++ b/src/testdir/test_statusline.vim
@@ -272,3 +272,13 @@ func Test_statusline()
   set laststatus&
   set splitbelow&
 endfunc
+
+" Used to write beyond allocated memory.  This assumes MAXPATHL is 4096 bytes.
+func Test_statusline_verylong_filename()
+  let fname = repeat('x', 4090)
+  exe "new " .. fname
+  set buftype=help
+  set previewwindow
+  redraw
+  bwipe!
+endfunc
-- 
2.25.1

