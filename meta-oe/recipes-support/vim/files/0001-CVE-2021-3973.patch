From c685c801755d9d581ca62343c92ca5c0539990eb Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 6 Dec 2021 17:04:15 +0530
Subject: [PATCH] CVE-2021-3973

Upstream-Status: Backport from https://github.com/vim/vim/commit/615ddd5342b50a6878a907062aa471740bd9a847

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/misc2.c                 | 3 +++
 src/normal.c                | 8 ++++----
 src/testdir/test_visual.vim | 8 ++++++++
 src/version.c               | 2 ++
 src/window.c                | 5 +++++
 5 files changed, 22 insertions(+), 4 deletions(-)

diff --git a/src/misc2.c b/src/misc2.c
index 17fa424bc..31727ff73 100644
--- a/src/misc2.c
+++ b/src/misc2.c
@@ -5530,6 +5530,9 @@ find_file_in_path_option(
     proc->pr_WindowPtr = (APTR)-1L;
 #endif
 
+    if (len == 0)
+	return NULL;
+
     if (first == TRUE)
     {
 	/* copy file name into NameBuff, expanding environment variables */
diff --git a/src/normal.c b/src/normal.c
index 1532a94ba..83da18bc5 100644
--- a/src/normal.c
+++ b/src/normal.c
@@ -5873,11 +5873,11 @@ get_visual_text(
 	    *pp = ml_get_pos(&VIsual);
 	    *lenp = curwin->w_cursor.col - VIsual.col + 1;
 	}
-#ifdef FEAT_MBYTE
-	if (has_mbyte)
-	    /* Correct the length to include the whole last character. */
+	if (**pp == NUL)
+	    *lenp = 0;
+	if (has_mbyte && *lenp > 0)
+	    // Correct the length to include all bytes of the last character.
 	    *lenp += (*mb_ptr2len)(*pp + (*lenp - 1)) - 1;
-#endif
     }
     reset_VIsual_and_resel();
     return OK;
diff --git a/src/testdir/test_visual.vim b/src/testdir/test_visual.vim
index e4bd10079..25d4be9c9 100644
--- a/src/testdir/test_visual.vim
+++ b/src/testdir/test_visual.vim
@@ -91,3 +91,11 @@ func Test_visual_mode_reset()
 
   set belloff&
 endfunc
+
+func Test_visual_block_ctrl_w_f()
+  " Emtpy block selected in new buffer should not result in an error.
+  au! BufNew foo sil norm f
+  edit foo
+
+  au! BufNew
+endfunc
diff --git a/src/version.c b/src/version.c
index 69ca48291..d180abfdc 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    989,
 /**/
     988,
 /**/
diff --git a/src/window.c b/src/window.c
index 311009837..6e0a17784 100644
--- a/src/window.c
+++ b/src/window.c
@@ -6296,7 +6296,12 @@ find_file_name_in_path(
     int		c;
 # if defined(FEAT_FIND_ID) && defined(FEAT_EVAL)
     char_u	*tofree = NULL;
+# endif
+
+    if (len == 0)
+	return NULL;
 
+# if defined(FEAT_FIND_ID) && defined(FEAT_EVAL)
     if ((options & FNAME_INCL) && *curbuf->b_p_inex != NUL)
     {
 	tofree = eval_includeexpr(ptr, len);
-- 
2.25.1

