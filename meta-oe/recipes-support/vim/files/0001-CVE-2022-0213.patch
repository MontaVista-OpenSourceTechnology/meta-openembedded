From 21177b0348652e843c9ee866b8be064ddb50b3bf Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Wed, 30 Mar 2022 10:58:15 +0530
Subject: [PATCH] CVE-2022-0213

Upstream-Status: Backport from https://github.com/vim/vim/commit/de05bb25733c3319e18dca44e9b59c6ee389eb26

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/screen.c              |  9 +++++----
 src/testdir/test_edit.vim | 15 +++++++++++++++
 src/version.c             |  2 ++
 3 files changed, 22 insertions(+), 4 deletions(-)

diff --git a/src/screen.c b/src/screen.c
index b37306941..261f2266b 100644
--- a/src/screen.c
+++ b/src/screen.c
@@ -6876,12 +6876,13 @@ win_redr_status(win_T *wp)
 	p = NameBuff;
 	len = (int)STRLEN(p);
 
-	if (bt_help(wp->w_buffer)
+	if ((bt_help(wp->w_buffer)
 #ifdef FEAT_QUICKFIX
-		|| wp->w_p_pvw
+		    || wp->w_p_pvw
 #endif
-		|| bufIsChanged(wp->w_buffer)
-		|| wp->w_buffer->b_p_ro)
+		    || bufIsChanged(wp->w_buffer)
+		    || wp->w_buffer->b_p_ro)
+		    && len < MAXPATHL - 1)
 	    *(p + len++) = ' ';
 	if (bt_help(wp->w_buffer))
 	{
diff --git a/src/testdir/test_edit.vim b/src/testdir/test_edit.vim
index 53de9580f..178c479a5 100644
--- a/src/testdir/test_edit.vim
+++ b/src/testdir/test_edit.vim
@@ -1375,3 +1375,18 @@ func Test_edit_put_CTRL_E()
   bwipe!
   set encoding=utf-8
 endfunc
+
+" Weird long file name was going over the end of NameBuff
+func Test_edit_overlong_file_name()
+  CheckUnix
+
+  file 0000000000000000000000000000
+  file %%%%%%%%%%%%%%%%%%%%%%%%%%
+  file %%%%%%
+  set readonly
+  set ls=2
+
+  redraw!
+  set noreadonly ls&
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index 184a79b00..401ca8616 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    995,
 /**/
     994,
 /**/
-- 
2.25.1

