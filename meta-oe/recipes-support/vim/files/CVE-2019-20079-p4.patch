From 740f3ac114da18e5f55abeb14eb351bbc96d34ca Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Tue, 24 Mar 2020 11:53:32 +0530
Subject: [PATCH 4/4] using freed memory with autocmd from fuzzer

Excluded changes from src/testdir/test_autocmd.vim, src/version.c

Upstream-Status: Backport from [ https://github.com/vim/vim/commit/ec66c41d84e ]
CVE: CVE-2019-20079
Signed-off-by: Milan Shah <mshah@mvista.com>

diff --git a/src/window.c b/src/window.c
index dd2529a..4989701 100644
--- a/src/window.c
+++ b/src/window.c
@@ -4444,6 +4444,7 @@ win_enter_ext(
 #ifdef FEAT_JOB_CHANNEL
     entering_window(curwin);
 #endif
+    // Careful: autocommands may close the window and make "wp" invalid
     if (trigger_new_autocmds)
 	apply_autocmds(EVENT_WINNEW, NULL, NULL, FALSE, curbuf);
     if (trigger_enter_autocmds)
@@ -4458,7 +4459,7 @@ win_enter_ext(
 #endif
     curwin->w_redr_status = TRUE;
 #ifdef FEAT_TERMINAL
-    if (bt_terminal(wp->w_buffer))
+    if (bt_terminal(curwin->w_buffer))
 	// terminal is likely in another mode
 	redraw_mode = TRUE;
 #endif
-- 
2.7.4

