From ad8d1c46c517c6838ee0b572ffd4218b639587ba Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Fri, 29 Oct 2021 11:00:55 +0530
Subject: [PATCH] CVE-2021-3778

Upstream-Status: Backport from https://github.com/vim/vim/commit/65b605665997fad54ef39a93199e305af2fe4d7f

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/regexp_nfa.c                 | 3 ++-
 src/testdir/test_regexp_utf8.vim | 8 ++++++++
 src/version.c                    | 2 ++
 3 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/regexp_nfa.c b/src/regexp_nfa.c
index 40d6605f0..4b4ffd34b 100644
--- a/src/regexp_nfa.c
+++ b/src/regexp_nfa.c
@@ -5485,7 +5485,8 @@ find_match_text(colnr_T startcol, int regstart, char_u *match_text)
 		match = FALSE;
 		break;
 	    }
-	    len2 += MB_CHAR2LEN(c2);
+	    len2 += enc_utf8 ? utf_ptr2len(regline + col + len2)
+							     : MB_CHAR2LEN(c2);
 	}
 	if (match
 #ifdef FEAT_MBYTE
diff --git a/src/testdir/test_regexp_utf8.vim b/src/testdir/test_regexp_utf8.vim
index bec5e0ed4..f5b713319 100644
--- a/src/testdir/test_regexp_utf8.vim
+++ b/src/testdir/test_regexp_utf8.vim
@@ -154,3 +154,11 @@ func Test_large_class()
   call assert_equal(1, "\u3042" =~# '[\u3000-\u4000]')
   set re=0
 endfunc
+
+func Test_match_invalid_byte()
+  call writefile(0z630a.765d30aa0a.2e0a.790a.4030, 'Xinvalid')
+  new
+  source Xinvalid
+  bwipe!
+  call delete('Xinvalid')
+endfunc
diff --git a/src/version.c b/src/version.c
index 3ca106467..f742a1bd6 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    984,
 /**/
     881,
 /**/
-- 
2.25.1

