From 34ae1e74f1903a387b3021f7fd09eb78b1905dd6 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 6 Dec 2021 17:18:11 +0530
Subject: [PATCH] CVE-2021-3974

Upstream-Status: Backport from https://github.com/vim/vim/commit/64066b9acd9f8cffdf4840f797748f938a13f2d6

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/regexp_nfa.c                  | 8 ++++++++
 src/testdir/test_regexp_latin.vim | 8 ++++++++
 src/version.c                     | 2 ++
 3 files changed, 18 insertions(+)

diff --git a/src/regexp_nfa.c b/src/regexp_nfa.c
index 509592c30..cd65b0557 100644
--- a/src/regexp_nfa.c
+++ b/src/regexp_nfa.c
@@ -6652,8 +6652,16 @@ nfa_regmatch(
 	    case NFA_MARK_GT:
 	    case NFA_MARK_LT:
 	      {
+		size_t	col = reginput - regline;
 		pos_T	*pos = getmark_buf(rex.reg_buf, t->state->val, FALSE);
 
+		// Line may have been freed, get it again.
+		if (REG_MULTI)
+		{
+		    regline = reg_getline(reglnum);
+		    reginput = regline + col;
+		}
+
 		/* Compare the mark position to the match position. */
 		result = (pos != NULL		     /* mark doesn't exist */
 			&& pos->lnum > 0    /* mark isn't set in reg_buf */
diff --git a/src/testdir/test_regexp_latin.vim b/src/testdir/test_regexp_latin.vim
index a8fa64d2a..f76f330de 100644
--- a/src/testdir/test_regexp_latin.vim
+++ b/src/testdir/test_regexp_latin.vim
@@ -72,3 +72,11 @@ func Test_backref()
   call assert_fails('call search("\\%#=2\\(e\\1\\)")', 'E65:')
   bwipe!
 endfunc
+
+func Test_using_mark_position()
+  " this was using freed memory
+  new
+  norm O0
+  call assert_fails("s/\\%')", 'E486:')
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index d180abfdc..9c24bfd1f 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    990,
 /**/
     989,
 /**/
-- 
2.25.1

