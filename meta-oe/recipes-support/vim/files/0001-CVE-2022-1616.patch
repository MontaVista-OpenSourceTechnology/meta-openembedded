From 65232c14bc5e9a266fec40f52106964799ee9a10 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 31 May 2022 10:28:27 +0530
Subject: [PATCH] CVE-2022-1616

Upstream-Status: Backport from https://github.com/vim/vim/commit/d88934406c5375d88f8f1b65331c9f0cab68cc6c

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/ex_docmd.c               |  4 +++-
 src/testdir/test_cmdline.vim | 11 +++++++++++
 src/version.c                |  2 ++
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/ex_docmd.c b/src/ex_docmd.c
index 7c4f7c851..4f4cddb21 100644
--- a/src/ex_docmd.c
+++ b/src/ex_docmd.c
@@ -3095,7 +3095,7 @@ append_command(char_u *cmd)
 
     STRCAT(IObuff, ": ");
     d = IObuff + STRLEN(IObuff);
-    while (*s != NUL && d - IObuff < IOSIZE - 7)
+    while (*s != NUL && d - IObuff + 5 < IOSIZE)
     {
 	if (
 #ifdef FEAT_MBYTE
@@ -3111,6 +3111,8 @@ append_command(char_u *cmd)
 	    STRCPY(d, "<a0>");
 	    d += 4;
 	}
+	else if (d - IObuff + (*mb_ptr2len)(s) + 1 >= IOSIZE)
+	    break;
 	else
 	    MB_COPY_CHAR(s, d);
     }
diff --git a/src/testdir/test_cmdline.vim b/src/testdir/test_cmdline.vim
index 1694b3edd..84e97f308 100644
--- a/src/testdir/test_cmdline.vim
+++ b/src/testdir/test_cmdline.vim
@@ -450,4 +450,15 @@ func Test_verbosefile()
   call delete('Xlog')
 endfunc
 
+" this was going over the end of IObuff
+func Test_report_error_with_composing()
+  let caught = 'no'
+  try
+    exe repeat('0', 987) .. "0\xdd\x80\xdd\x80\xdd\x80\xdd\x80"
+  catch /E492:/
+    let caught = 'yes'
+  endtry
+  call assert_equal('yes', caught)
+endfunc
+
 set cpo&
diff --git a/src/version.c b/src/version.c
index bcee53f80..988a536b2 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4895,
 /**/
     4440,
 /**/
-- 
2.25.1

