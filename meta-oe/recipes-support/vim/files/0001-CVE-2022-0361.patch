From 6b18e6993b732230568b64c572b0e0ae5455e69f Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 14 Apr 2022 11:59:12 +0530
Subject: [PATCH] CVE-2022-0361

Upstream-Status: Backport from https://github.com/vim/vim/commit/dc5490e2cbc8c16022a23b449b48c1bd0083f366

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/ex_cmds.c               |  2 ++
 src/testdir/test_visual.vim | 11 +++++++++++
 src/version.c               |  2 ++
 3 files changed, 15 insertions(+)

diff --git a/src/ex_cmds.c b/src/ex_cmds.c
index a9b1656f0..dd99586aa 100644
--- a/src/ex_cmds.c
+++ b/src/ex_cmds.c
@@ -964,6 +964,8 @@ ex_copy(linenr_T line1, linenr_T line2, linenr_T n)
     }
 
     appended_lines_mark(n, count);
+    if (VIsual_active)
+	check_pos(curbuf, &VIsual);
 
     msgmore((long)count);
 }
diff --git a/src/testdir/test_visual.vim b/src/testdir/test_visual.vim
index 65165a728..0fd89fe43 100644
--- a/src/testdir/test_visual.vim
+++ b/src/testdir/test_visual.vim
@@ -108,3 +108,14 @@ func Test_visual_block_append_invalid_char()
   call assert_equal(['	-   let xxx', 'xxxxx   -', 'xxxxxxxx-xxx'], getline(1, 3))
   bwipe!
 endfunc
+
+" this was leaving the end of the Visual area beyond the end of a line
+func Test_visual_ex_copy_line()
+  new
+  call setline(1, ["aaa", "bbbbbbbbbxbb"])
+  /x
+  exe "normal ggvjfxO"
+  t0
+  normal gNU
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index b70620b5c..c85aacfc9 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4215,
 /**/
     4214,
 /**/
-- 
2.25.1

