From 70df39bc47f7ab3edc89ee03a8dc599a20f5e37b Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 18 Apr 2022 09:55:16 +0530
Subject: [PATCH] CVE-2022-0368

Upstream-Status: Backport from https://github.com/vim/vim/commit/8d02ce1ed75d008c34a5c9aaa51b67cbb9d33baa

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/testdir/test_visual.vim | 15 +++++++++++++++
 src/undo.c                  |  2 ++
 src/version.c               |  2 ++
 3 files changed, 19 insertions(+)

diff --git a/src/testdir/test_visual.vim b/src/testdir/test_visual.vim
index 0fd89fe43..7378a215b 100644
--- a/src/testdir/test_visual.vim
+++ b/src/testdir/test_visual.vim
@@ -119,3 +119,18 @@ func Test_visual_ex_copy_line()
   normal gNU
   bwipe!
 endfunc
+
+" This was leaving the end of the Visual area beyond the end of a line.
+" Set 'undolevels' to start a new undo block.
+func Test_visual_undo_deletes_last_line()
+  new
+  call setline(1, ["aaa", "ccc", "dyd"])
+  set undolevels=100
+  exe "normal obbbbbbbbbxbb\<Esc>"
+  set undolevels=100
+  /y
+  exe "normal ggvjfxO"
+  undo
+  normal gNU
+  bwipe!
+endfunc
diff --git a/src/undo.c b/src/undo.c
index b913841f7..08418a2eb 100644
--- a/src/undo.c
+++ b/src/undo.c
@@ -2964,6 +2964,8 @@ u_undo_end(
 	}
     }
 #endif
+    if (VIsual_active)
+	check_pos(curbuf, &VIsual);
 
     smsg((char_u *)_("%ld %s; %s #%ld  %s"),
 	    u_oldcount < 0 ? -u_oldcount : u_oldcount,
diff --git a/src/version.c b/src/version.c
index c85aacfc9..16413bbf5 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4217,
 /**/
     4215,
 /**/
-- 
2.25.1

