From 9a9b5c28b8976aac77f8a2e1b6ebaf96d18fdd6d Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Fri, 14 Jun 2024 05:13:20 +0000
Subject: [PATCH] CVE-2023-0054

---
 src/eval.c                      |  5 +++++
 src/testdir/test_substitute.vim | 16 ++++++++++++++++
 src/version.c                   |  2 ++
 3 files changed, 23 insertions(+)

diff --git a/src/eval.c b/src/eval.c
index 062fab0ac..86108f944 100644
--- a/src/eval.c
+++ b/src/eval.c
@@ -7099,6 +7099,11 @@ do_string_sub(
	     * - The text after the match.
	     */
	    sublen = vim_regsub(&regmatch, sub, expr, tail, 0, REGSUB_MAGIC);
+	    if (sublen <= 0)
+	    {
+		ga_clear(&ga);
+		break;
+	    }
	    if (ga_grow(&ga, (int)((end - tail) + sublen -
			    (regmatch.endp[0] - regmatch.startp[0]))) == FAIL)
	    {
diff --git a/src/testdir/test_substitute.vim b/src/testdir/test_substitute.vim
index 67df60ff9..533d66f89 100644
--- a/src/testdir/test_substitute.vim
+++ b/src/testdir/test_substitute.vim
@@ -1096,6 +1096,22 @@ func Test_sub_edit_scriptfile()
   bwipe!
 endfunc

+func Test_recursive_expr_substitute()
+  " this was reading invalid memory
+  let lines =<< trim END
+      func Repl(g, n)
+        s
+        r%:s000
+      endfunc
+      next 0
+      let caught = 0
+      s/\%')/\=Repl(0, 0)
+      qall!
+  END
+  call writefile(lines, 'XexprSubst', 'D')
+  call RunVim([], [], '--clean -S XexprSubst')
+endfunc
+
 " Test for the 2-letter and 3-letter :substitute commands
 func Test_substitute_short_cmd()
   new
diff --git a/src/version.c b/src/version.c
index 2d2ae6aae..f14d0813c 100644
--- a/src/version.c
+++ b/src/version.c
@@ -695,6 +695,8 @@ static char *(features[]) =

 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    1145,
 /**/
     820,
 /**/
--
2.18.2
