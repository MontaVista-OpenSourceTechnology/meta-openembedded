From 96892e9023ab5d13dd66ae9157a9bf008dbcf2e0 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Fri, 4 Feb 2022 16:12:29 +0530
Subject: [PATCH] CVE-2021-4019

Upstream-Status: Backport from https://github.com/vim/vim/commit/bd228fd097b41a798f90944b5d1245eddd484142

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/ex_cmds.c             | 3 +--
 src/testdir/test_help.vim | 8 ++++++++
 src/version.c             | 2 ++
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/ex_cmds.c b/src/ex_cmds.c
index ab1e61a7c..a9b1656f0 100644
--- a/src/ex_cmds.c
+++ b/src/ex_cmds.c
@@ -6583,8 +6583,7 @@ find_help_tags(
 		    || (vim_strchr((char_u *)"%_z@", arg[1]) != NULL
 							   && arg[2] != NUL)))
 	{
-	    STRCPY(d, "/\\\\");
-	    STRCPY(d + 3, arg + 1);
+	    vim_snprintf((char *)d, IOSIZE, "/\\\\%s", arg + 1);
 	    /* Check for "/\\_$", should be "/\\_\$" */
 	    if (d[3] == '_' && d[4] == '$')
 		STRCPY(d + 4, "\\$");
diff --git a/src/testdir/test_help.vim b/src/testdir/test_help.vim
index 5a35b691a..1da2d9690 100644
--- a/src/testdir/test_help.vim
+++ b/src/testdir/test_help.vim
@@ -13,3 +13,11 @@ func Test_help_errors()
   call assert_fails('help doesnotexist', 'E149:')
   call assert_fails('help!', 'E478:')
 endfunc
+
+func Test_help_long_argument()
+  try
+    exe 'help \%' .. repeat('0', 1021)
+  catch
+    call assert_match("E149:", v:exception)
+  endtry
+endfunc
diff --git a/src/version.c b/src/version.c
index 9c24bfd1f..fcdebf412 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    991,
 /**/
     990,
 /**/
-- 
2.25.1

