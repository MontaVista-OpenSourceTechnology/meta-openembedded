From 3fcdebe6e7610a7347192a9a763214e83201cf63 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 24 Mar 2022 12:31:09 +0530
Subject: [PATCH] CVE-2021-4192

Upstream-Status: Backport from https://github.com/vim/vim/commit/4c13e5e6763c6eb36a343a2b8235ea227202e952

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/regexp.c                      | 7 ++++++-
 src/testdir/test_regexp_latin.vim | 8 ++++++++
 src/version.c                     | 2 ++
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/regexp.c b/src/regexp.c
index c4745ce7a..f762dee5b 100644
--- a/src/regexp.c
+++ b/src/regexp.c
@@ -4223,7 +4223,12 @@ reg_match_visual(void)
 	    end = end2;
 	if (top.col == MAXCOL || bot.col == MAXCOL)
 	    end = MAXCOL;
-	cols = win_linetabsize(wp, regline, (colnr_T)(reginput - regline));
+
+	// getvvcol() flushes rex.line, need to get it again
+	regline = reg_getline(reglnum);
+	reginput = regline + col;
+
+	cols = win_linetabsize(wp, regline, col);
 	if (cols < start || cols > end - (*p_sel == 'e'))
 	    return FALSE;
     }
diff --git a/src/testdir/test_regexp_latin.vim b/src/testdir/test_regexp_latin.vim
index f76f330de..e5776cdbe 100644
--- a/src/testdir/test_regexp_latin.vim
+++ b/src/testdir/test_regexp_latin.vim
@@ -80,3 +80,11 @@ func Test_using_mark_position()
   call assert_fails("s/\\%')", 'E486:')
   bwipe!
 endfunc
+
+func Test_using_visual_position()
+  " this was using freed memory
+  new
+  exe "norm 0o\<Esc>\<C-V>k\<C-X>o0"
+  /\%V
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index 1179e65b9..184a79b00 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    994,
 /**/
     993,
 /**/
-- 
2.25.1

