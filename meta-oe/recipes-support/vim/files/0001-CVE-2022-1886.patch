From 38dcfb12f26e923358680763d8b8938546a83254 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 7 Jun 2022 11:32:00 +0530
Subject: [PATCH] CVE-2022-1886

Upstream-Status: Backport from https://github.com/vim/vim/commit/2a585c85013be22f59f184d49612074fd9b115d7

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/ops.c                | 9 ++++++++-
 src/testdir/test_put.vim | 9 +++++++++
 src/version.c            | 2 ++
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/ops.c b/src/ops.c
index e7bbd292e..f78b1930c 100644
--- a/src/ops.c
+++ b/src/ops.c
@@ -3866,6 +3866,7 @@ do_put(
 	}
 	else
 	{
+	    size_t	len;
 	    /*
 	     * Insert at least one line.  When y_type is MCHAR, break the first
 	     * line in two.
@@ -3975,9 +3976,15 @@ error:
 	    /* put '] mark at last inserted character */
 	    curbuf->b_op_end.lnum = lnum;
 	    /* correct length for change in indent */
-	    col = (colnr_T)STRLEN(y_array[y_size - 1]) - lendiff;
+	    len = STRLEN(y_array[y_size - 1]);
+	    col = (colnr_T)len - lendiff;
 	    if (col > 1)
+	    {
 		curbuf->b_op_end.col = col - 1;
+		if (len > 0)
+		    curbuf->b_op_end.col -= mb_head_off(y_array[y_size - 1],
+						y_array[y_size - 1] + len - 1);
+	    }
 	    else
 		curbuf->b_op_end.col = 0;
 
diff --git a/src/testdir/test_put.vim b/src/testdir/test_put.vim
index a56705bfe..440ccb69c 100644
--- a/src/testdir/test_put.vim
+++ b/src/testdir/test_put.vim
@@ -54,3 +54,12 @@ func Test_put_above_first_line()
   call assert_equal('text', getline(1))
   bwipe!
 endfunc
+
+" this was putting a mark before the start of a line
+func Test_put_empty_register()
+  new
+  norm yy
+  norm [Pi00ggv)s0
+  sil! norm [P
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index 314fa669a..d9f40eb7f 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    5016,
 /**/
     4925,
 /**/
-- 
2.25.1

