From 1917ea2ddac45e00f685ec96a0490c851f79a834 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 19 Apr 2022 10:38:36 +0530
Subject: [PATCH] CVE-2022-0443

Upstream-Status: Backport from https://github.com/vim/vim/commit/9b4a80a66544f2782040b641498754bcb5b8d461

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/buffer.c                  | 11 +++++++++--
 src/testdir/test_quickfix.vim | 16 ++++++++++++++++
 src/version.c                 |  2 ++
 3 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/src/buffer.c b/src/buffer.c
index daef76194..8ee65375c 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -1696,6 +1696,7 @@ set_curbuf(buf_T *buf, int action)
     long	old_tw = curbuf->b_p_tw;
 #endif
     bufref_T	bufref;
+    int		valid;
 
     setpcmark();
     if (!cmdmod.keepalt)
@@ -1753,7 +1754,8 @@ set_curbuf(buf_T *buf, int action)
     /* An autocommand may have deleted "buf", already entered it (e.g., when
      * it did ":bunload") or aborted the script processing.
      * If curwin->w_buffer is null, enter_buffer() will make it valid again */
-    if ((buf_valid(buf) && buf != curbuf
+    valid = buf_valid(buf);
+    if ((valid && buf != curbuf
 # ifdef FEAT_EVAL
 	    && !aborting()
 # endif
@@ -1763,7 +1765,12 @@ set_curbuf(buf_T *buf, int action)
        )
 #endif
     {
-	enter_buffer(buf);
+	// If the buffer is not valid but curwin->w_buffer is NULL we must
+	// enter some buffer.  Using the last one is hopefully OK.
+	if (!valid)
+	    enter_buffer(lastbuf);
+	else
+	    enter_buffer(buf);
 #ifdef FEAT_SYN_HL
 	if (old_tw != curbuf->b_p_tw)
 	    check_colorcolumn(curwin);
diff --git a/src/testdir/test_quickfix.vim b/src/testdir/test_quickfix.vim
index 8fa715395..ef859ec4f 100644
--- a/src/testdir/test_quickfix.vim
+++ b/src/testdir/test_quickfix.vim
@@ -1138,6 +1138,7 @@ func XquickfixChangedByAutocmd(cchar)
   call assert_fails('Xrewind', ErrorNr . ':')
 
   augroup! testgroup
+  delfunc R
 endfunc
 
 func Test_quickfix_was_changed_by_autocmd()
@@ -2519,3 +2520,18 @@ func Test_add_qf()
   call XaddQf_tests('c')
   call XaddQf_tests('l')
 endfunc
+
+" Weird sequence of commands that caused entering a wiped-out buffer
+func Test_lopen_bwipe()
+  func R()
+    silent! tab lopen
+    e x
+    silent! lfile
+  endfunc
+
+  cal R()
+  cal R()
+  cal R()
+  bw!
+  delfunc R
+endfunc
diff --git a/src/version.c b/src/version.c
index 3f12bc171..9457f4c6e 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4281,
 /**/
     4218,
 /**/
-- 
2.25.1

