From 9f32fe0e166b5bb42b6a3aa65ec24a8afd9661f2 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 14 Apr 2022 11:54:31 +0530
Subject: [PATCH] CVE-2022-0359

Upstream-Status: Backport from https://github.com/vim/vim/commit/85b6747abc15a7a81086db31289cf1b8b17e6cb1

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/ex_getln.c               | 2 +-
 src/testdir/test_ex_mode.vim | 9 +++++++++
 src/version.c                | 2 ++
 3 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/ex_getln.c b/src/ex_getln.c
index 74d793735..9bd33d11c 100644
--- a/src/ex_getln.c
+++ b/src/ex_getln.c
@@ -257,7 +257,7 @@ getcmdline(
     ccline.cmdindent = (firstc > 0 ? indent : 0);
 
     /* alloc initial ccline.cmdbuff */
-    alloc_cmdbuff(exmode_active ? 250 : indent + 1);
+    alloc_cmdbuff(indent + 50);
     if (ccline.cmdbuff == NULL)
 	return NULL;			    /* out of memory */
     ccline.cmdlen = ccline.cmdpos = 0;
diff --git a/src/testdir/test_ex_mode.vim b/src/testdir/test_ex_mode.vim
index 821a045f0..f0f48678c 100644
--- a/src/testdir/test_ex_mode.vim
+++ b/src/testdir/test_ex_mode.vim
@@ -65,3 +65,12 @@ func Test_open_command_flush_line()
   endtry
   bwipe!
 endfunc
+
+func Test_ex_mode_large_indent()
+  new
+  set ts=500 ai
+  call setline(1, "\t")
+  exe "normal gQi\<CR>."
+  set ts=8 noai
+  bwipe!
+endfunc
diff --git a/src/version.c b/src/version.c
index 8a68efd5a..b70620b5c 100644
--- a/src/version.c
+++ b/src/version.c
@@ -769,6 +769,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4214,
 /**/
     997,
 /**/
-- 
2.25.1

