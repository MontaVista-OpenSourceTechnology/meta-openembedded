From c9f6193a1d671d8ee7c717776dff352a59accbb2 Mon Sep 17 00:00:00 2001
From: Tomasz Buchert <tomasz@debian.org>
Date: Fri, 23 Aug 2019 19:03:07 +0200
Subject: [PATCH] Fix CVE-2019-9511 and CVE-2019-9513

Adapted cherry-pick of 83d362c6d21f76599b86e7b94cd1992288a1d43c.

Upstream-Status: Backport from 1.18.1-1+deb9u1
CVE: CVE-2019-9511 & CVE-2019-9513
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 src/HttpServer.cc           | 2 ++
 src/shrpx_client_handler.cc | 9 +++++++--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/HttpServer.cc b/src/HttpServer.cc
index 8466fec..86536bf 100644
--- a/src/HttpServer.cc
+++ b/src/HttpServer.cc
@@ -650,6 +650,7 @@ int Http2Handler::read_clear() {
       }
       return -1;
     }
+    break;
   }
 
   return write_(*this);
@@ -775,6 +776,7 @@ int Http2Handler::read_tls() {
       }
       return -1;
     }
+    break;
   }
 
 fin:
diff --git a/src/shrpx_client_handler.cc b/src/shrpx_client_handler.cc
index bf81f71..64376a5 100644
--- a/src/shrpx_client_handler.cc
+++ b/src/shrpx_client_handler.cc
@@ -115,6 +115,7 @@ int ClientHandler::noop() { return 0; }
 
 int ClientHandler::read_clear() {
   rb_.ensure_chunk();
+  auto should_break = false;
   for (;;) {
     if (rb_.rleft() && on_read() != 0) {
       return -1;
@@ -126,7 +127,7 @@ int ClientHandler::read_clear() {
       return 0;
     }
 
-    if (!ev_is_active(&conn_.rev)) {
+    if (!ev_is_active(&conn_.rev) || should_break) {
       return 0;
     }
 
@@ -144,6 +145,7 @@ int ClientHandler::read_clear() {
     }
 
     rb_.write(nread);
+    should_break = true;
   }
 }
 
@@ -208,6 +210,8 @@ int ClientHandler::tls_handshake() {
 }
 
 int ClientHandler::read_tls() {
+  auto should_break = false;
+
   ERR_clear_error();
 
   rb_.ensure_chunk();
@@ -224,7 +228,7 @@ int ClientHandler::read_tls() {
       return 0;
     }
 
-    if (!ev_is_active(&conn_.rev)) {
+    if (!ev_is_active(&conn_.rev) || should_break) {
       return 0;
     }
 
@@ -242,6 +246,7 @@ int ClientHandler::read_tls() {
     }
 
     rb_.write(nread);
+    should_break = true;
   }
 }
 
-- 
2.7.4

