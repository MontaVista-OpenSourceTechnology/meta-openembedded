From 6600301e85581bced9a36d102ca7968a9397236a Mon Sep 17 00:00:00 2001
From: "Thomas E. Dickey" <dickey@invisible-island.net>
Date: Wed, 10 Feb 2021 01:14:51 +0000
Subject: [PATCH 2/2] snapshot of project "xterm", label xterm-365e

Upstream Status: Backport https://github.com/ThomasDickey/xterm-snapshots/commit/f80e543c6dee5ecfe54c58d351fe418ce5f1959b
CVE: CVE-2021-27135 patch #2

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 button.c | 22 ++++++++++++++--------
 1 file changed, 14 insertions(+), 8 deletions(-)

diff --git a/button.c b/button.c
index 8e75994..1d20600 100644
--- a/button.c
+++ b/button.c
@@ -3871,14 +3871,20 @@ SaltTextAway(XtermWidget xw,
      * the estimate is too-far off.
      */
     if ((have * 2) < (size_t) j) {
+	Char *next;
 	screen->selection_size = have + 1;
-	line = realloc(line, screen->selection_size);
+	next = realloc(line, screen->selection_size);
+	if (next == NULL) {
+	    free(line);
+	    screen->selection_length = 0;
+	    screen->selection_size = 0;
+	}
+	screen->selection_data = next;
     }
+    screen->selection_length = have;
 
     TRACE(("Salted TEXT:%u:%s\n", (unsigned) have,
-	   visibleChars(line, (unsigned) have)));
-
-    screen->selection_length = have;
+	   visibleChars(screen->selection_data, (unsigned) have)));
 }
 
 #if OPT_PASTE64
@@ -4345,8 +4351,8 @@ _OwnSelection(XtermWidget xw,
     if (count == 0)
 	return;
 
-    TRACE(("_OwnSelection count %d, length %ld value %s\n", count,
-	   screen->selection_length,
+    TRACE(("_OwnSelection count %d, length %lu value %s\n", count,
+	   (unsigned long) screen->selection_length,
 	   visibleChars(screen->selection_data, (unsigned) screen->selection_length)));
     selections = MapSelections(xw, selections, count);
 
@@ -4364,9 +4370,9 @@ _OwnSelection(XtermWidget xw,
 	    (unsigned long) (4 * XMaxRequestSize(XtDisplay((Widget) xw)) - 32);
 	    if (screen->selection_length > limit) {
 		TRACE(("selection too big (%lu bytes), not storing in CUT_BUFFER%d\n",
-		       screen->selection_length, cutbuffer));
+		       (unsigned long) screen->selection_length, cutbuffer));
 		xtermWarning("selection too big (%lu bytes), not storing in CUT_BUFFER%d\n",
-			     screen->selection_length, cutbuffer);
+			     (unsigned long) screen->selection_length, cutbuffer);
 	    } else {
 		/* This used to just use the UTF-8 data, which was totally
 		 * broken as not even the corresponding paste code in xterm
-- 
2.31.1

