From 854e23782cd73990df07a2c2713bed9ac417a65e Mon Sep 17 00:00:00 2001
From: "Thomas E. Dickey" <dickey@invisible-island.net>
Date: Tue, 9 Feb 2021 23:04:41 +0000
Subject: [PATCH 1/2] snapshot of project "xterm", label xterm-365d

Upstream Status: Backport https://github.com/ThomasDickey/xterm-snapshots/commit/82ba55b8f994ab30ff561a347b82ea340ba7075c
CVE: CVE-2021-27135 patch #1

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 button.c | 23 +++++++++++++++++++----
 1 file changed, 19 insertions(+), 4 deletions(-)

diff --git a/button.c b/button.c
index 43ef7b0..8e75994 100644
--- a/button.c
+++ b/button.c
@@ -3797,6 +3797,7 @@ SaltTextAway(XtermWidget xw,
 {
     TScreen *screen = TScreenOf(xw);
     int i, j = 0;
+    size_t have = 0;
     int eol;
     Char *line;
     Char *lp;
@@ -3823,7 +3824,11 @@ SaltTextAway(XtermWidget xw,
 
     /* UTF-8 may require more space */
     if_OPT_WIDE_CHARS(screen, {
-	j *= 4;
+	if (j > 0) {
+	    if (screen->max_combining > 0)
+		j += screen->max_combining;
+	    j *= 6;
+	}
     });
 
     /* now get some memory to save it in */
@@ -3860,10 +3865,20 @@ SaltTextAway(XtermWidget xw,
     }
     *lp = '\0';			/* make sure we have end marked */
 
-    TRACE(("Salted TEXT:%d:%s\n", (int) (lp - line),
-	   visibleChars(line, (unsigned) (lp - line))));
+    have = (size_t) (lp - line);
+    /*
+     * Scanning the buffer twice is unnecessary.  Discard unwanted memory if
+     * the estimate is too-far off.
+     */
+    if ((have * 2) < (size_t) j) {
+	screen->selection_size = have + 1;
+	line = realloc(line, screen->selection_size);
+    }
+
+    TRACE(("Salted TEXT:%u:%s\n", (unsigned) have,
+	   visibleChars(line, (unsigned) have)));
 
-    screen->selection_length = (unsigned long) (lp - line);
+    screen->selection_length = have;
 }
 
 #if OPT_PASTE64
-- 
2.31.1

