From ab60992c9e839ce4ae945b26c52cf7b78e288053 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Tue, 9 Aug 2022 04:22:56 +0000
Subject: [PATCH] CVE-2021-43818_1

Cleaner: Prevent "@import" from re-occurring in the CSS after replacements, e.g. "@@importimport".

Reported as GHSL-2021-1037

Upstream-Status: Backport from https://github.com/lxml/lxml/commit/12fa9669007180a7bb87d990c375cf91ca5b664a
CVE: CVE-2021-43818
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 src/lxml/html/clean.py            |  2 ++
 src/lxml/html/tests/test_clean.py | 20 ++++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/src/lxml/html/clean.py b/src/lxml/html/clean.py
index c7a2c19..22f6afc 100644
--- a/src/lxml/html/clean.py
+++ b/src/lxml/html/clean.py
@@ -513,6 +513,8 @@ class Cleaner(object):
             return True
         if 'expression(' in style:
             return True
+        if '@import' in style:
+            return True
         if '</noscript' in style:
             # e.g. '<noscript><style><a title="</noscript><img src=x onerror=alert(1)>">'
             return True
diff --git a/src/lxml/html/tests/test_clean.py b/src/lxml/html/tests/test_clean.py
index 451eec2..1751b0b 100644
--- a/src/lxml/html/tests/test_clean.py
+++ b/src/lxml/html/tests/test_clean.py
@@ -89,6 +89,26 @@ class CleanerTest(unittest.TestCase):
             b'<math><style>/* deleted */</style></math>',
             lxml.html.tostring(clean_html(s)))
 
+    def test_sneaky_import_in_style(self):
+        # Prevent "@@importimport" -> "@import" replacement.
+        style_codes = [
+            "@@importimport(extstyle.css)",
+            "@ @  import import(extstyle.css)",
+            "@ @ importimport(extstyle.css)",
+            "@@  import import(extstyle.css)",
+            "@ @import import(extstyle.css)",
+            "@@importimport()",
+        ]
+        for style_code in style_codes:
+            html = '<style>%s</style>' % style_code
+            s = lxml.html.fragment_fromstring(html)
+
+            cleaned = lxml.html.tostring(clean_html(s))
+            self.assertEqual(
+                b'<style>/* deleted */</style>',
+                cleaned,
+                "%s  ->  %s" % (style_code, cleaned))
+
 
 def test_suite():
     suite = unittest.TestSuite()
-- 
2.18.2

